(function(){function e(e){this.editor=e;this.specialParsers={};this.DEFAULT_NODE_NAME="span",this.WHITE_SPACE_REG_EXP=/\s+/,this.defaultRules={tags:{},classes:{}};this.convertedBxNodes=[];this.rules={}}e.prototype={Parse:function(e,t,r,i,s){if(!r){r=document}this.convertedBxNodes=[];var a=r.createDocumentFragment(),n=this.GetAsDomElement(e,r),o,l,d;this.SetParseBxMode(s);while(n.firstChild){d=n.firstChild;n.removeChild(d);o=this.Convert(d,i,s,o);if(o){l=!s&&this.CheckBlockNode(o);if(l){}a.appendChild(o);if(l){a.appendChild(this.editor.util.GetInvisibleTextNode())}}}n.innerHTML="";n.appendChild(a);e=this.editor.GetInnerHtml(n);e=this.RegexpContentParse(e,s);return e},SetParseBxMode:function(e){this.bParseBx=!!e},CodeParse:function(e){return e},GetAsDomElement:function(e,t){if(!t)t=document;var r=t.createElement("DIV");if(typeof e==="object"&&e.nodeType){r.appendChild(e)}else if(this.editor.util.CheckHTML5Support()){r.innerHTML=e}else if(this.editor.util.CheckHTML5FullSupport()){r.style.display="none";t.body.appendChild(r);try{r.innerHTML=e}catch(i){}t.body.removeChild(r)}return r},Convert:function(e,t,r,i){var s=false,a=e.nodeType,n=e.childNodes,o,l,d,u;if(a==1){if(e.nodeName=="IMG"){if(!e.getAttribute("data-bx-orig-src"))e.setAttribute("data-bx-orig-src",e.getAttribute("src"));else e.setAttribute("src",e.getAttribute("data-bx-orig-src"))}if(this.editor.pasteHandleMode&&(r||this.editor.bbParseContentMode)){if(e.id=="bx-cursor-node"){return e.ownerDocument.createTextNode(this.editor.INVISIBLE_CURSOR)}s=!e.getAttribute("data-bx-paste-flag");if(s&&e.nodeName=="IMG"&&e.getAttribute("data-bx-orig-src")){s=false}if(e&&e.id){u=this.editor.GetBxTag(e.id);if(u.tag){s=false}}if(s){e=this.CleanNodeAfterPaste(e,i);if(!e){return null}n=e.childNodes;a=e.nodeType}e.removeAttribute("data-bx-paste-flag")}else{if(e.id=="bx-cursor-node"){return e.cloneNode(true)}}if(a==1){if(!e.__bxparsed){if(this.IsAnchor(e)&&!e.getAttribute("data-bx-replace_with_children")){o=e.cloneNode(true);o.innerHTML="";l=null;for(d=0;d<n.length;d++){l=this.Convert(n[d],t,r,l);if(l){o.appendChild(l)}}var h={};for(d=0;d<o.attributes.length;d++){if(o.attributes[d].name!=="name")h[o.attributes[d].name]=o.attributes[d].value}e=this.editor.phpParser.GetSurrogateNode("anchor",BX.message("BXEdAnchor")+": #"+o.name,null,{html:o.innerHTML,name:o.name,attributes:h})}else if(this.IsPrintBreak(e)){e=this.GetPrintBreakSurrogate(e)}if(e&&e.id){u=this.editor.GetBxTag(e.id);if(u.tag){e.__bxparsed=1;if(this.bParseBx){o=e.ownerDocument.createTextNode("~"+u.id+"~");this.convertedBxNodes.push(u)}else{o=e.cloneNode(true)}return o}}if(!o&&e.nodeType){o=this.ConvertElement(e,r)}}}}else if(a==3){o=this.HandleText(e)}if(!o){return null}for(d=0;d<n.length;d++){l=this.Convert(n[d],t,r);if(l){o.appendChild(l)}}if(o.nodeType==1){if(o.style&&BX.util.trim(o.style.cssText)==""&&o.removeAttribute){o.removeAttribute("style")}if(this.editor.config.cleanEmptySpans&&t&&o.childNodes.length<=1&&o.nodeName.toLowerCase()===this.DEFAULT_NODE_NAME&&!o.attributes.length){return o.firstChild}}return o},ConvertElement:function(e,t){var r,i,s,a=this.editor.GetParseRules().tags,n=e.nodeName.toLowerCase(),o=e.scopeName;if(e.__bxparsed){return null}e.__bxparsed=1;if(e.className==="bx-editor-temp"){return null}if(o&&o!="HTML"){n=o+":"+n}if("outerHTML"in e&&!this.editor.util.AutoCloseTagSupported()&&e.nodeName==="P"&&e.outerHTML.slice(-4).toLowerCase()!=="</p>"){n="div"}if(n=="table"&&!this.bParseBx){var l=parseInt(e.getAttribute("border"),10);if(!l){e.removeAttribute("border");e.setAttribute("data-bx-no-border","Y")}}if(n in a){r=a[n];if(!r||r.remove){return null}if(r.clean_empty&&(e.innerHTML===""||e.innerHTML===this.editor.INVISIBLE_SPACE)&&(!e.className||e.className=="")&&(!this.editor.lastCreatedId||this.editor.lastCreatedId!=e.getAttribute("data-bx-last-created-id"))){return null}r=typeof r==="string"?{rename_tag:r}:r;s=e.getAttribute("data-bx-new-rule");if(s){r[s]=e.getAttribute("data-bx-"+s)}}else if(e.firstChild){r={rename_tag:this.DEFAULT_NODE_NAME}}else{return null}if(r.replace_with_children){i=e.ownerDocument.createDocumentFragment()}else{i=e.ownerDocument.createElement(r.rename_tag||n);this.HandleAttributes(e,i,r,t)}if(s){r[s]=null;delete r[s]}e=null;return i},CleanNodeAfterPaste:function(e,t){var r,i,s,a,n=e.nodeName,o=e.innerHTML,l=BX.util.trim(o),d={align:1,alt:1,bgcolor:1,border:1,cellpadding:1,cellspacing:1,color:1,colspan:1,height:1,href:1,rowspan:1,size:1,span:1,src:1,style:1,target:1,title:1,type:1,value:1,width:1},u={A:1,SPAN:1,B:1,STRONG:1,I:1,EM:1,U:1,DEL:1,S:1,STRIKE:1,H1:1,H2:1,H3:1,H4:1,H5:1,H6:1},h={"background-color":"transparent","background-image":1,"background-position":1,"background-repeat":1,background:1,"border-collapse":1,"border-color":1,"border-style":1,"border-top":1,"border-right":1,"border-bottom":1,"border-left":1,"border-top-color":1,"border-right-color":1,"border-bottom-color":1,"border-left-color":1,"border-top-style":1,"border-right-style":1,"border-bottom-style":1,"border-left-style":1,"border-top-width":1,"border-right-width":1,"border-bottom-width":1,"border-left-width":1,"border-width":1,border:1,color:"#000000","font-style":"normal","font-weight":"normal","text-decoration":"none",height:1,width:1};if(e.style.display=="none"||e.style.visibility=="hidden"){return null}if(u[n]&&o==""){return null}var c=e.getAttribute("data-bx-clean-attribute");if(c){e.removeAttribute(c);e.removeAttribute("data-bx-clean-attribute")}if(n=="IMG"){var f=e.getAttribute("data-bx-orig-src");if(f)e.setAttribute("src",f)}if(n=="A"&&(l==""||l=="&nbsp;")){return null}if(n=="A"){}e.removeAttribute("class");e.removeAttribute("id");a=0;while(a<e.attributes.length){s=e.attributes[a].name;if(!d[s]){e.removeAttribute(s)}else{a++}}if(n=="DIV"||e.style.display=="block"){if(!e.lastChild||e.lastChild&&e.lastChild.nodeName!="BR"){e.appendChild(e.ownerDocument.createElement("BR")).setAttribute("data-bx-paste-flag","Y")}if(t&&typeof t=="object"&&t.nodeType==3&&e.firstChild){e.insertBefore(e.ownerDocument.createElement("BR"),e.firstChild).setAttribute("data-bx-paste-flag","Y")}e.setAttribute("data-bx-new-rule","replace_with_children");e.setAttribute("data-bx-replace_with_children","1")}if(n=="B"&&e.style.fontWeight=="normal"){e.setAttribute("data-bx-new-rule","replace_with_children");e.setAttribute("data-bx-replace_with_children","1")}if(this.IsAnchor(e)&&(e.name==""||BX.util.trim(e.name==""))){e.setAttribute("data-bx-new-rule","replace_with_children");e.setAttribute("data-bx-replace_with_children","1")}var g,p;if(e.style&&BX.util.trim(e.style.cssText)!=""){a=0;g=[];while(a<e.style.length){r=e.style[a];i=e.style.getPropertyValue(r);if(!h[r]||i==h[r]){e.style.removeProperty(r);continue}if(r.indexOf("color")!==-1){i=this.editor.util.RgbToHex(i);if(i==h[r]||i=="transparent"||i=="black"){e.style.removeProperty(r);continue}}if(r.indexOf("border")!==-1&&i.indexOf("none")!==-1){e.style.removeProperty(r);continue}g.push({name:r,value:i});a++}e.removeAttribute("style");if(g.length>0){for(p=0;p<g.length;p++){e.style[g[p].name]=g[p].value}}}else{e.removeAttribute("style")}if(n=="SPAN"&&e.style.cssText==""){e.setAttribute("data-bx-new-rule","replace_with_children");e.setAttribute("data-bx-replace_with_children","1")}if((n=="P"||n=="SPAN"||n=="FONT")&&BX.util.trim(e.innerHTML)=="&nbsp;"){e.innerHTML=" "}return e},HandleText:function(e){var t=e.data;if(this.editor.pasteHandleMode&&t.indexOf("EndFragment:")!==-1){t=t.replace(/Version:\d\.\d(?:\s|\S)*?StartHTML:\d+(?:\s|\S)*?EndHTML:\d+(?:\s|\S)*?StartFragment:\d+(?:\s|\S)*?EndFragment:\d+(?:\s|\n|\t|\r)*/g,"")}return e.ownerDocument.createTextNode(t)},HandleAttributes:function(e,t,r,i){var s={},a=r.set_class,n=r.add_class,o=r.add_css,l=r.set_attributes,d=r.check_attributes,u=r.clear_attributes,h=this.editor.GetParseRules().classes,c=0,f,g={},p,m=[],b=[],T=[],P=[],v,B,x,S,C,y,A,I;if(d){for(y in d){I=this.GetCheckAttributeHandler(d[y]);if(!I)continue;A=I(this.GetAttributeEx(e,y));if(typeof A==="string"&&A!=="")s[y]=A}}var E=e.getAttribute("data-bx-clean-attribute");if(E){e.removeAttribute(E);e.removeAttribute("data-bx-clean-attribute")}if(!u){for(c=0;c<e.attributes.length;c++){C=e.attributes[c];if(i){if(C.name.substr(0,15)=="data-bx-app-ex-"){f=C.name.substr(15);s[f]=e.getAttribute(C.name);g[f]=true}if(g[C.name]){continue}}if(C.name.substr(0,8)=="data-bx-"&&C.name!="data-bx-noindex"&&this.bParseBx){continue}s[C.name]=this.GetAttributeEx(e,C.name)}}if(a)m.push(a);if(o){for(p in o){if(o.hasOwnProperty(p))t.style[p]=o[p]}}P=e.getAttribute("class");if(P)m=m.concat(P.split(this.WHITE_SPACE_REG_EXP));v=m.length;for(;c<v;c++){x=m[c];if(h[x])b.push(x)}if(T.length)s["class"]=T.join(" ");for(y in s){try{t.setAttribute(y,s[y])}catch(N){}}if(s.src){if(typeof s.width!=="undefined")t.setAttribute("width",s.width);if(typeof s.height!=="undefined")t.setAttribute("height",s.height)}},GetAttributeEx:function(e,t){t=t.toLowerCase();var r,i=e.nodeName;if(i=="IMG"&&t=="src"&&this.IsLoadedImage(e)===true){r=e.getAttribute("src")}else if(!this.editor.util.CheckGetAttributeTruth()&&"outerHTML"in e){var s=e.outerHTML.toLowerCase(),a=s.indexOf(" "+t+"=")!=-1;r=a?e.getAttribute(t):null}else{r=e.getAttribute(t)}return r},IsLoadedImage:function(e){try{return e.complete&&!e.mozMatchesSelector(":-moz-broken")}catch(t){if(e.complete&&e.readyState==="complete")return true}return false},GetCheckAttributeHandler:function(e){var t=this.GetCheckAttributeHandlers();return t[e]},GetCheckAttributeHandlers:function(){return{url:function(e){return e},alt:function(e){if(!e){return""}return e.replace(/[^ a-z0-9_\-]/gi,"")},numbers:function(e){e=(e||"").replace(/\D/g,"");return e||null}}},HandleBitrixNode:function(e){return e},RegexpContentParse:function(e,t){if(e.indexOf("rgb")!==-1){e=e.replace(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)/gi,function(e,t,r,i,s){function a(e){return("0"+parseInt(e).toString(16)).slice(-2)}return"#"+a(t)+a(r)+a(i)})}if(t&&e.indexOf("data-bx-noindex")!==-1){e=e.replace(/(<a[\s\S]*?)data\-bx\-noindex="Y"([\s\S]*?\/a>)/gi,function(e,t,r){return"<!--noindex-->"+t+r+"<!--/noindex-->"})}if(t){e=e.replace(/\uFEFF/gi,"")}else{e=e.replace(/\uFEFF+/gi,this.editor.INVISIBLE_SPACE)}if(t&&e.indexOf("#BXAPP")!==-1){var r=this;e=e.replace(/#BXAPP(\d+)#/g,function(e,t){t=parseInt(t,10);return r.editor.phpParser.AdvancedPhpGetFragmentByIndex(t,true)})}return e},IsAnchor:function(e){return e.nodeName=="A"&&!e.href},IsPrintBreak:function(e){return e.style.pageBreakAfter=="always"},GetPrintBreakSurrogate:function(e){var t=this.editor.GetIframeDoc(),r=this.editor.SetBxTag(false,{tag:"printbreak",params:{innerHTML:BX.util.trim(e.innerHTML)},name:BX.message("BXEdPrintBreakName"),title:BX.message("BXEdPrintBreakTitle")});return BX.create("IMG",{props:{src:this.editor.EMPTY_IMAGE_SRC,id:r,className:"bxhtmled-printbreak",title:BX.message("BXEdPrintBreakTitle")}},t)},CheckBlockNode:function(e){return this.editor.phpParser.IsSurrogate(e)||e.nodeType==1&&(e.style.display=="block"||e.style.display=="inline-block"||e.nodeName=="BLOCKQUOTE"||e.nodeName=="DIV")}};function t(e){this.PHP_PATTERN="#BXPHP_IND#";this.editor=e;this.allowed={php:this.editor.allowPhp||this.editor.lpa,javascript:true,style:true,htmlcomment:true,iframe:true,video:true,object:true};this.bUseAPP=true;this.APPConfig={arTags_before:["tbody","thead","tfoot","tr","td","th"],arTags_after:["tbody","thead","tfoot","tr","td","th"],arTags:{a:["href","title","class","style"],img:["src","alt","class","style","width","height"]}};this.customParsers=[];this.arScripts={};this.arJavascripts={};this.arHtmlComments={};this.arIframes={};this.arVideos={};this.arStyles={};this.arObjects={};this.surrClass="bxhtmled-surrogate";this.surrogateTags={component:1,php:1,javascript:1,style:1,htmlcomment:1,anchor:1,iframe:1,video:1,object:1};BX.addCustomEvent(this.editor,"OnIframeMouseDown",BX.proxy(this.OnSurrogateMousedown,this));BX.addCustomEvent(this.editor,"OnIframeDblClick",BX.proxy(this.OnSurrogateDblClick,this));BX.addCustomEvent(this.editor,"OnIframeKeydown",BX.proxy(this.OnSurrogateKeydown,this));BX.addCustomEvent(this.editor,"OnAfterCommandExec",BX.proxy(this.RenewSurrogates,this))}t.prototype={ParsePhp:function(e){var t=this;if(this.IsAllowed("php")){e=this.ReplacePhpBySymCode(e)}else{e=this.CleanPhp(e)}e=this.CustomContentParse(e);e=this.ReplaceJavascriptBySymCode(e);e=this.ReplaceHtmlCommentsBySymCode(e);e=this.ReplaceIframeBySymCode(e);e=this.ReplaceStyleBySymCode(e);e=this.ReplaceObjectBySymCode(e);e=this.ParseBreak(e);e=this.AdvancedPhpParse(e);e=this.ParseSymCode(e);if(this.editor.lpa){e=e.replace(/#PHP(\d+)#/g,function(e){return t.GetSurrogateHTML("php_protected",BX.message("BXEdPhpCode")+" *",BX.message("BXEdPhpCodeProtected"),{value:e})})}return e},ReplacePhpBySymCode:function(e,t){var r=[],i=0,s,a,n,o,l,d,u,h=0;t=t===true;while((i=e.indexOf("<?",i))>=0){h=0;s=i+2;a=false;n=false;while(s<e.length-1){s++;o=e.substr(s,1);if(!n){if(o=="/"&&s+1<e.length){l=e.indexOf("?>",s);if(l==-1){i=e.length;break}l+=2;d=0;if(e.substr(s+1,1)=="*"&&(d=e.indexOf("*/",s+2))>=0){d+=2}else if(e.substr(s+1,1)=="/"&&(d=e.indexOf("\n",s+2))>=0){d+=1}if(d>0){if(d>l&&e.substr(s+1,1)!="*"){r.push([i,l,e.substr(i,l-i)]);i=l;break}else{s=d-1}}continue}if(o=="?"&&s+1<e.length&&e.substr(s+1,1)==">"){s=s+2;r.push([i,s,e.substr(i,s-i)]);i=s+1;break}}if(n&&o=="\\"){a=true;continue}if(o=='"'||o=="'"){if(n){if(!a&&u==o)n=false}else{n=true;u=o}}a=false}if(s>=e.length)break;i=s}this.arScripts={};if(r.length>0){var c="",f=0,g;if(t){for(s=0;s<r.length;s++){g=r[s];c+=e.substr(f,g[0]-f);f=g[1]}}else{for(s=0;s<r.length;s++){g=r[s];c+=e.substr(f,g[0]-f)+this.SavePhpCode(g[2],s);f=g[1]}}e=c+e.substr(f)}return e},CleanPhp:function(e){return this.ReplacePhpBySymCode(e,true)},ReplaceJavascriptBySymCode:function(e){this.arJavascripts={};var t=this,r=0;e=e.replace(/<script[\s\S]*?\/script>/gi,function(e){t.arJavascripts[r]=e;var i=t.GetPattern(r,false,"javascript");r++;return i});return e},ReplaceHtmlCommentsBySymCode:function(e){this.arHtmlComments={};var t=this,r=0;e=e.replace(/(<!--noindex-->)(?:[\s|\n|\r|\t]*?)<a([\s\S]*?)\/a>(?:[\s|\n|\r|\t]*?)(<!--\/noindex-->)/gi,function(e,t,r,i){return'<a data-bx-noindex="Y"'+r+"/a>"});e=e.replace(/<!--[\s\S]*?-->/gi,function(e){t.arHtmlComments[r]=e;return t.GetPattern(r++,false,"html_comment")});return e},ReplaceIframeBySymCode:function(e){this.arIframes={};var t=this,r=0;e=e.replace(/<iframe([\s\S]*?)\/iframe>/gi,function(e,i){var s=t.CheckForVideo(i);if(s){t.arVideos[r]={html:e,provider:s.provider||false,src:s.src||false};return t.GetPattern(r++,false,"video")}else{t.arIframes[r]=e;return t.GetPattern(r++,false,"iframe")}});return e},ReplaceStyleBySymCode:function(e){this.arStyles={};var t=this,r=0;e=e.replace(/<style[\s\S]*?\/style>/gi,function(e){t.arStyles[r]=e;return t.GetPattern(r++,false,"style")});return e},ReplaceObjectBySymCode:function(e){this.arObjects={};var t=this,r=0;e=e.replace(/<object[\s\S]*?\/object>/gi,function(e){t.arObjects[r]=e;return t.GetPattern(r++,false,"object")});e=e.replace(/<embed[\s\S]*?(?:\/embed)?>/gi,function(e){t.arObjects[r]=e;return t.GetPattern(r++,false,"object")});return e},CheckForVideo:function(e){var t=/(?:src)\s*=\s*("|')([\s\S]*?((?:youtube.com)|(?:youtu.be)|(?:rutube.ru)|(?:vimeo.com))[\s\S]*?)(\1)/gi;var r=t.exec(e);if(r){return{src:r[2],provider:this.GetVideoProviderName(r[3])}}else{return false}},GetVideoProviderName:function(e){var t="";switch(e){case"youtube.com":case"youtu.be":t="YouTube";break;case"rutube.ru":t="Rutube";break;case"vimeo.com":t="Vimeo";break}return t},SavePhpCode:function(e,t){this.arScripts[t]=e;return this.GetPhpPattern(t,false)},GetPhpPattern:function(e,t){if(t)return new RegExp("#BXPHP_"+e+"#","ig");else return"#BXPHP_"+e+"#"},GetPattern:function(e,t,r){var i;switch(r){case"php":i="#BXPHP_";break;case"javascript":i="#BXJAVASCRIPT_";break;case"html_comment":i="#BXHTMLCOMMENT_";break;case"iframe":i="#BXIFRAME_";break;case"style":i="#BXSTYLE_";break;case"video":i="#BXVIDEO_";break;case"object":i="#BXOBJECT_";break;default:return""}return t?new RegExp(i+e+"#","ig"):i+e+"#"},ParseSymCode:function(e){var t=this;e=e.replace(/#BX(PHP|JAVASCRIPT|HTMLCOMMENT|IFRAME|STYLE|VIDEO|OBJECT)_(\d+)#/g,function(e,r,i){var s="";if(t.IsAllowed(r.toLowerCase())){switch(r){case"PHP":s=t.GetPhpCodeHTML(t.arScripts[i]);break;case"JAVASCRIPT":s=t.GetJavascriptCodeHTML(t.arJavascripts[i]);break;case"HTMLCOMMENT":s=t.GetHtmlCommentHTML(t.arHtmlComments[i]);break;case"IFRAME":s=t.GetIframeHTML(t.arIframes[i]);break;case"STYLE":s=t.GetStyleHTML(t.arStyles[i]);break;case"VIDEO":s=t.GetVideoHTML(t.arVideos[i]);break;case"OBJECT":s=t.GetObjectHTML(t.arObjects[i]);break}}return s});return e},GetPhpCodeHTML:function(e){var t="",r=this.editor.components.IsComponent(e);if(r!==false){var i=this.editor.components.GetComponentData(r.name),s=i.title||r.name,a=i.params&&i.params.DESCRIPTION?i.params.DESCRIPTION:a;if(i.className){r.className=i.className||""}t=this.GetSurrogateHTML("component",s,a,r)}else{if(this.editor.allowPhp){t=this.GetSurrogateHTML("php",BX.message("BXEdPhpCode"),BX.message("BXEdPhpCode")+": "+this.GetShortTitle(e,200),{value:e})}else{t=""}}return t},GetJavascriptCodeHTML:function(e){return this.GetSurrogateHTML("javascript","Javascript","Javascript: "+this.GetShortTitle(e,200),{value:e})},GetHtmlCommentHTML:function(e){return this.GetSurrogateHTML("htmlcomment",BX.message("BXEdHtmlComment"),BX.message("BXEdHtmlComment")+": "+this.GetShortTitle(e),{value:e})},GetIframeHTML:function(e){return this.GetSurrogateHTML("iframe",BX.message("BXEdIframe"),BX.message("BXEdIframe")+": "+this.GetShortTitle(e),{value:e})},GetStyleHTML:function(e){return this.GetSurrogateHTML("style",BX.message("BXEdStyle"),BX.message("BXEdStyle")+": "+this.GetShortTitle(e),{value:e})},GetVideoHTML:function(e){var t="video",r=e.params||this.FetchVideoIframeParams(e.html,e.provider);r.value=e.html;var i=this.editor.SetBxTag(false,{tag:t,name:r.title,params:r}),s=this.editor.SetBxTag(false,{tag:"surrogate_dd",params:{origParams:r,origId:i}});this.editor.SetBxTag({id:i},{tag:t,name:r.title,params:r,title:r.title,surrogateId:s});var a='<span id="'+i+'" title="'+r.title+'"  class="'+this.surrClass+" bxhtmled-video-surrogate"+'" '+'style="min-width:'+r.width+"px; max-width:"+r.width+"px; min-height:"+r.height+"px; max-height:"+r.height+'px"'+">"+'<img title="'+r.title+'" id="'+s+'" class="bxhtmled-surrogate-dd" src="'+this.editor.util.GetEmptyImage()+'"/>'+'<span class="bxhtmled-surrogate-inner"><span class="bxhtmled-video-icon"></span><span class="bxhtmled-comp-lable" spellcheck=false>'+r.title+"</span></span>"+"</span>";return a},GetObjectHTML:function(e){return this.GetSurrogateHTML("object",BX.message("BXEdObjectEmbed"),BX.message("BXEdObjectEmbed")+": "+this.GetShortTitle(e),{value:e})},FetchVideoIframeParams:function(e,t){var r=/((?:src)|(?:title)|(?:width)|(?:height))\s*=\s*("|')([\s\S]*?)(\2)/gi,i={src:"",width:180,height:100,title:t?BX.message("BXEdVideoTitleProvider").replace("#PROVIDER_NAME#",t):BX.message("BXEdVideoTitle"),origTitle:""};e.replace(r,function(e,t,r,s){t=t.toLowerCase();if(t=="width"||t=="height"){s=parseInt(s,10);if(s&&!isNaN(s)){i[t]=s}}else if(t=="title"){i.origTitle=BX.util.htmlspecialcharsback(s);i.title+=": "+s}else{i[t]=s}return e});return i},GetSurrogateHTML:function(e,t,r,i){if(r){r=BX.util.htmlspecialchars(r);r=r.replace('"','"')}if(!i){i={}}var s=this.editor.SetBxTag(false,{tag:e,name:t,params:i}),a=this.editor.SetBxTag(false,{tag:"surrogate_dd",params:{origParams:i,origId:s}});this.editor.SetBxTag({id:s},{tag:e,name:t,params:i,title:r,surrogateId:a});if(!this.surrogateTags.tag){this.surrogateTags.tag=1}var n='<span id="'+s+'" title="'+(r||t)+'"  class="'+this.surrClass+(i.className?" "+i.className:"")+'">'+this.GetSurrogateInner(a,r,t)+"</span>";return n},GetSurrogateNode:function(e,t,r,i){var s=this.editor.GetIframeDoc(),a=this.editor.SetBxTag(false,{tag:e,name:t,params:i,title:r}),n=this.editor.SetBxTag(false,{tag:"surrogate_dd",params:{origParams:i,origId:a}});if(!i)i={};this.editor.SetBxTag({id:a},{tag:e,name:t,params:i,title:r,surrogateId:n});if(!this.surrogateTags.tag){this.surrogateTags.tag=1}return BX.create("SPAN",{props:{id:a,title:r||t,className:this.surrClass+(i.className?" "+i.className:"")},html:this.GetSurrogateInner(n,r,t)},s)},GetSurrogateInner:function(e,t,r){return'<img title="'+(t||r)+'" id="'+e+'" class="bxhtmled-surrogate-dd" src="'+this.editor.util.GetEmptyImage()+'"/>'+'<span class="bxhtmled-surrogate-inner"><span class="bxhtmled-right-side-item-icon"></span><span class="bxhtmled-comp-lable" unselectable="on" spellcheck=false>'+BX.util.htmlspecialchars(r)+"</span></span>"},GetShortTitle:function(e,t){if(e.length>100)e=e.substr(0,100)+"...";return e},_GetUnParsedContent:function(e){var t=this;e=e.replace(/#BX(PHP|JAVASCRIPT|HTMLCOMMENT|IFRAME|STYLE|VIDEO|OBJECT)_(\d+)#/g,function(e,r,i){var s;switch(r){case"PHP":s=t.arScripts[i];break;case"JAVASCRIPT":s=t.arJavascripts[i];break;case"HTMLCOMMENT":s=t.arHtmlComments[i];break;case"IFRAME":s=t.arIframes[i];break;case"STYLE":s=t.arStyles[i];break;case"VIDEO":s=t.arVideos[i].html;break;case"OBJECT":s=t.arObjects[i].html;break}return s});return e},IsSurrogate:function(e){return e&&BX.hasClass(e,this.surrClass)},TrimPhpBrackets:function(e){if(e.substr(0,2)!="<?")return e;if(e.substr(0,5).toLowerCase()=="<?php")e=e.substr(5);else e=e.substr(2);e=e.substr(0,e.length-2);return e},TrimQuotes:function(e,t){var r,i;e=e.trim();if(t==undefined){r=e.substr(0,1);i=e.substr(0,1);if(r=='"'&&i=='"'||r=="'"&&i=="'")e=e.substring(1,e.length-1)}else{if(!t.length)return e;r=e.substr(0,1);i=e.substr(0,1);t=t.substr(0,1);if(r==t&&i==t)e=e.substring(1,e.length-1)}return e},CleanCode:function(e){var t=false,r=false,i="",s=-1,a,n,o;while(s<e.length-1){s++;a=e.substr(s,1);if(!r){if(a=="/"&&s+1<e.length){n=0;if(e.substr(s+1,1)=="*"&&(n=e.indexOf("*/",s+2))>=0)n+=2;else if(e.substr(s+1,1)=="/"&&(n=e.indexOf("\n",s+2))>=0)n+=1;if(n>0){if(s>n)alert("iti="+s+"="+n);s=n}continue}if(a==" "||a=="\r"||a=="\n"||a=="	")continue}if(r&&a=="\\"){t=true;i+=a;continue}if(a=='"'||a=="'"){if(r){if(!t&&o==a)r=false}else{r=true;o=a}}t=false;i+=a}return i},ParseFunction:function(e){var t=e.indexOf("("),r=e.lastIndexOf(")");if(t>=0&&r>=0&&t<r)return{name:e.substr(0,t),params:e.substring(t+1,r)};return false},ParseParameters:function(e){e=this.CleanCode(e);var t=this.GetParams(e),r,i,s=t.length;for(i=0;i<s;i++){if(t[i].substr(0,6).toLowerCase()=="array("){t[i]=this.GetArray(t[i])}else{r=this.TrimQuotes(t[i]);if(this.IsNum(r)||t[i]!=r)t[i]=r;else t[i]=this.WrapPhpBrackets(t[i])}}return t},GetArray:function(e){var t={};if(e.substr(0,6).toLowerCase()!="array(")return e;e=e.substring(6,e.length-1);var r=this.GetParams(e),i,s,a,n;for(n=0;n<r.length;n++){if(r[n].substr(0,6).toLowerCase()=="array("){t[n]=this.GetArray(r[n]);continue}a=r[n].indexOf("=>");if(a==-1){if(r[n]==this.TrimQuotes(r[n]))t[n]=this.WrapPhpBrackets(r[n]);else t[n]=this.TrimQuotes(r[n])}else{i=this.TrimQuotes(r[n].substr(0,a));s=r[n].substr(a+2);if(s==this.TrimQuotes(s))s=this.WrapPhpBrackets(s);else s=this.TrimQuotes(s);if(s.substr(0,6).toLowerCase()=="array(")s=this.GetArray(s);t[i]=s}}return t},WrapPhpBrackets:function(e){e=e.trim();var t=e.substr(0,1),r=e.substr(0,1);if(t=='"'&&r=='"'||t=="'"&&r=="'")return e;return"={"+e+"}"},GetParams:function(e){var t=[],r=0,i,s,a=1,n=1,o,l="";for(o=0;o<e.length;o++){i=e.substr(o,1);if(i=='"'&&n==1&&!s){a*=-1}else if(i=="'"&&a==1&&!s){n*=-1}else if(i=="\\"&&!s){s=true;l+=i;continue}if(s)s=false;if(n==-1||a==-1){l+=i;continue}if(i=="("){r++}else if(i==")"){r--}else if(i==","&&r==0){t.push(l);l="";continue}if(r<0)break;l+=i}if(l!="")t.push(l);return t},IsNum:function(e){var t=e;e=parseFloat(t);if(isNaN(e))e=parseInt(t);if(!isNaN(e))return t==e;return false},ParseBxNodes:function(e){var t,r=this.editor.parser.convertedBxNodes,i=r.length;for(t=0;t<i;t++){if(r[t].tag=="surrogate_dd"){e=e.replace("~"+r[t].params.origId+"~","")}}this._skipNodeIndex={};this._skipNodeList=[];var s=this;e=e.replace(/~(bxid\d{1,9})~/gi,function(e,t){if(!s._skipNodeIndex[t]){var r=s.editor.GetBxTag(t);if(r&&r.tag){var i=s.GetBxNode(r.tag);if(i){return i.Parse(r.params)}}}return""});return e},GetBxNodeList:function(){var e=this;this.arBxNodes={component:{Parse:function(t){return e.editor.components.GetSource(t)}},component_icon:{Parse:function(t){return e.editor.components.GetOnDropHtml(t)}},surrogate_dd:{Parse:function(t){if(BX.browser.IsFirefox()||!t||!t.origId){return""}var r=e.editor.GetBxTag(t.origId);if(r){e._skipNodeIndex[t.origId]=true;e._skipNodeList.push(t.origId);var i=e.GetBxNode(r.tag);if(i){return i.Parse(r.params)}}return"#parse surrogate_dd#"}},php:{Parse:function(t){return e._GetUnParsedContent(t.value)}},php_protected:{Parse:function(e){return e.value}},javascript:{Parse:function(t){return e._GetUnParsedContent(t.value)}},htmlcomment:{Parse:function(t){return e._GetUnParsedContent(t.value)}},iframe:{Parse:function(t){return e._GetUnParsedContent(t.value)}},style:{Parse:function(t){return e._GetUnParsedContent(t.value)}},video:{Parse:function(t){return e._GetUnParsedContent(t.value)}},object:{Parse:function(t){return e._GetUnParsedContent(t.value)}},anchor:{Parse:function(e){var t="";if(e.attributes){for(var r in e.attributes){if(e.attributes.hasOwnProperty(r)){t+=r+'="'+e.attributes[r]+'" '}}}return"<a "+t+(e.name?'name="'+e.name+'"':"")+">"+e.html+"</a>"}},pagebreak:{Parse:function(e){return"<BREAK />"}},printbreak:{Parse:function(e){return'<div style="page-break-after: always">'+e.innerHTML+"</div>"}}};this.editor.On("OnGetBxNodeList");return this.arBxNodes},AddBxNode:function(e,t){if(this.arBxNodes==undefined){var r=this;BX.addCustomEvent(this.editor,"OnGetBxNodeList",function(){r.arBxNodes[e]=t})}else{this.arBxNodes[e]=t}},GetBxNode:function(e){if(!this.arBxNodes){this.arBxNodes=this.GetBxNodeList()}return this.arBxNodes[e]||null},OnSurrogateMousedown:function(e,t,r){var i=this;if(r.tag=="surrogate_dd"){BX.bind(t,"dragstart",function(e){i.OnSurrogateDragStart(e,this)});BX.bind(t,"dragend",function(e){i.OnSurrogateDragEnd(e,this,r)})}else{setTimeout(function(){var e=i.CheckParentSurrogate(i.editor.selection.GetSelectedNode());if(e){i.editor.selection.SetAfter(e);if(!e.nextSibling||e.nextSibling.nodeType!=3){var t=i.editor.util.GetInvisibleTextNode();i.editor.selection.InsertNode(t);i.editor.selection.SetAfter(t)}}},0)}},OnSurrogateDragEnd:function(e,t,r){if(!document.querySelectorAll)return;var i=this.editor.GetIframeDoc(),s,a,n,o={},l=i.querySelectorAll(".bxhtmled-surrogate"),d=i.querySelectorAll(".bxhtmled-surrogate-dd"),u=l.length;for(s=0;s<d.length;s++){if(d[s]&&d[s].id==r.id){BX.remove(d[s])}}for(s=0;s<u;s++){a=l[s];if(o[a.id]){if(a.getAttribute("data-bx-paste-flag")=="Y"||o[a.id].getAttribute("data-bx-paste-flag")!="Y")BX.remove(a);else if(o[a.id].getAttribute("data-bx-paste-flag")=="Y")BX.remove(o[a.id])}else{o[a.id]=a;n=this.editor.GetBxTag(a.id);a.innerHTML=this.GetSurrogateInner(n.surrogateId,n.title,n.name)}}},OnSurrogateDragStart:function(e,t){if(BX.browser.IsFirefox()){this.editor.GetIframeDoc().body.appendChild(t)}},CheckParentSurrogate:function(e){if(!e){return false}if(this.IsSurrogate(e)){return e}var t=this,r=0,i=BX.findParent(e,function(e){return r++>4||t.IsSurrogate(e)},this.editor.GetIframeDoc().body);return this.IsSurrogate(i)?i:false},CheckSurrogateDd:function(e){return e&&e.nodeType==1&&this.editor.GetBxTag(e).tag=="surrogate_dd"},OnSurrogateClick:function(e,t){var r=this.editor.GetBxTag(t);if(r&&r.tag=="surrogate_dd"){var i=this.editor.GetBxTag(r.params.origId);this.editor.On("OnSurrogateClick",[r,i,t,e])}},OnSurrogateDblClick:function(e,t){var r=this.editor.GetBxTag(t);if(r&&r.tag=="surrogate_dd"){var i=this.editor.GetBxTag(r.params.origId);this.editor.On("OnSurrogateDblClick",[r,i,t,e])}},OnSurrogateKeyup:function(e,t,r,i){var s,a,n=this.editor.selection.GetRange();if(n){if(n.collapsed){}else{}}},OnSurrogateKeydown:function(e,t,r,i){var s,a=this.editor.KEY_CODES,n=this.editor.selection.GetRange(),o,l,d,u=i;if(!n.collapsed){if(t===a["backspace"]||t===a["delete"]){var h,c=n.getNodes([3]);for(h=0;h<c.length;h++){s=this.editor.util.CheckSurrogateNode(c[h]);if(s){l=this.editor.GetBxTag(s);if(this.surrogateTags[l.tag]){this.RemoveSurrogate(s,l)}}}}}if(t===a["delete"]&&n.collapsed){o=this.editor.util.GetInvisibleTextNode();this.editor.selection.InsertNode(o);this.editor.selection.SetAfter(o);var f=o.nextSibling;if(f){if(f&&f.nodeName=="BR"){f=f.nextSibling}if(f&&f.nodeType==3&&(f.nodeValue=="\n"||this.editor.util.IsEmptyNode(f))){f=f.nextSibling}if(f){BX.remove(o);l=this.editor.GetBxTag(f);if(this.surrogateTags[l.tag]){this.RemoveSurrogate(f,l);return BX.PreventDefault(e)}}}}else if(t===a["backspace"]&&n.collapsed){o=this.editor.util.GetInvisibleTextNode();this.editor.selection.InsertNode(o);this.editor.selection.SetAfter(o);var g=this.editor.util.GetPreviousNotEmptySibling(o);if(g&&this.editor.phpParser.IsSurrogate(g)){BX.remove(g);if(o)BX.remove(o);return BX.PreventDefault(e)}else{if(o)BX.remove(o)}}if(n.startContainer==n.endContainer&&n.startContainer.nodeName!=="BODY"){u=n.startContainer;d=this.editor.util.CheckSurrogateNode(u);if(d){l=this.editor.GetBxTag(d.id);if(t===a["backspace"]||t===a["delete"]){this.RemoveSurrogate(d,l);BX.PreventDefault(e)}else if(t===a["left"]||t===a["up"]){var p=d.previousSibling;if(p&&p.nodeType==3&&this.editor.util.IsEmptyNode(p))this.editor.selection._MoveCursorBeforeNode(p);else this.editor.selection._MoveCursorBeforeNode(d);return BX.PreventDefault(e)}else if(t===a["right"]||t===a["down"]){var m=d.nextSibling;if(m&&m.nodeType==3&&this.editor.util.IsEmptyNode(m))this.editor.selection._MoveCursorAfterNode(m);else this.editor.selection._MoveCursorAfterNode(d);return BX.PreventDefault(e)}else if(t===a.shift||t===a.ctrl||t===a.alt||t===a.cmd||t===a.cmdRight){return BX.PreventDefault(e)}else{this.editor.selection._MoveCursorAfterNode(d)}}}},RemoveSurrogate:function(e,t){this.editor.undoManager.Transact();BX.remove(e);this.editor.On("OnSurrogateRemove",[e,t])},CheckHiddenSurrogateDrag:function(){var e,t;for(t=0;t<this.hiddenDd.length;t++){e=this.editor.GetIframeElement(this.hiddenDd[t]);if(e){e.style.visibility=""}}this.hiddenDd=[]},GetAllSurrogates:function(e){if(!document.querySelectorAll)return[];e=e===true;var t=this.editor.GetIframeDoc(),r=[],i,s,a,n=t.querySelectorAll(".bxhtmled-surrogate");for(i=0;i<n.length;i++){s=n[i];a=this.editor.GetBxTag(s.id);if(a.tag||e){r.push({node:s,bxTag:a})}}return r},RenewSurrogates:function(){var e=true,t,r={},i,s=this.GetAllSurrogates(true);for(t=0;t<s.length;t++){if(!s[t].bxTag.tag){BX.remove(s[t].node);continue}i=s[t].bxTag.surrogateId;if(!r[i]||!e){r[i]=i;s[t].node.innerHTML=this.GetSurrogateInner(s[t].bxTag.surrogateId,s[t].bxTag.title,s[t].bxTag.name)}else{BX.remove(s[t].node)}}},RedrawSurrogates:function(){var e,t=this.GetAllSurrogates();for(e=0;e<t.length;e++){if(t[e].node){BX.addClass(t[e].node,"bxhtmled-surrogate-tmp")}}setTimeout(function(){for(e=0;e<t.length;e++){if(t[e].node){BX.removeClass(t[e].node,"bxhtmled-surrogate-tmp")}}},0)},IsAllowed:function(e){return this.allowed[e]},AdvancedPhpParse:function(e){if(this.bUseAPP){this.arAPPFragments=[];e=this.AdvancedPhpParseInAttributes(e)}return e},AdvancedPhpParseBetweenTableTags:function(e){var t=this;function r(e,r,i,s,a){t.arAPPFragments.push(JS_addslashes(r));return i+s+' data-bx-php-before="#BXAPP'+(t.arAPPFragments.length-1)+'#" '+a}function i(e,r,i,s,a){t.arAPPFragments.push(JS_addslashes(a));return r+">"+s+"<"+i+' style="display:none;" data-bx-php-after="#BXAPP'+(t.arAPPFragments.length-1)+'#"></'+i+">"}var s=t.APPConfig.arTags_before,a=t.APPConfig.arTags_after,n,o,d;for(o=0;o<s.length;o++){n=s[o];if(t.limit_php_access)d=new RegExp("#(PHP(?:\\d{4}))#(\\s*)(<"+n+"[^>]*?)(>)","ig");else d=new RegExp("<\\?(.*?)\\?>(\\s*)(<"+n+"[^>]*?)(>)","ig");e=e.replace(d,r)}for(o=0,l=a.length;o<l;o++){n=a[o];if(t.limit_php_access)d=new RegExp("(</("+n+")[^>]*?)>(\\s*)#(PHP(?:\\d{4}))#","ig");
else d=new RegExp("(</("+n+")[^>]*?)>(\\s*)<\\?(.*?)\\?>","ig");e=e.replace(d,i)}return e},AdvancedPhpParseInAttributes:function(e){var t=this,r=this.APPConfig.arTags,i,s,a,n;function o(e,r,i,s,a,n,o){if(a.indexOf("#BXPHP_")===-1){return e}t.arAPPFragments.push(a);var l=t.arAPPFragments.length-1;var d=t.AdvancedPhpGetFragmentByIndex(l,true);return r+i+'="'+d+'"'+" data-bx-app-ex-"+i+'="#BXAPP'+l+'#"'+n}for(i in r){if(r.hasOwnProperty(i)){for(a=0;a<r[i].length;a++){s=r[i][a];n=new RegExp("(<"+i+"(?:[^>](?:\\?>)*?)*?)("+s+")\\s*=\\s*((?:\"|')?)([\\s\\S]*?)\\3((?:[^>](?:\\?>)*?)*?>)","ig");e=e.replace(n,o)}}}return e},AdvancedPhpUnParse:function(e){return e},AdvancedPhpGetFragmentByCode:function(e,t){var r=e.substr(6);r=parseInt(r.substr(0,r.length-1),10);return this.AdvancedPhpGetFragmentByIndex(r,t)},AdvancedPhpGetFragmentByIndex:function(e,t){var r=this,i=this.arAPPFragments[e];i=i.replace(/#BXPHP_(\d+)#/g,function(e,i){var s=r.arScripts[parseInt(i,10)];if(t){var a=r.GetSiteTemplatePath();if(a){s=s.replace(/<\?=\s*SITE_TEMPLATE_PATH;?\s*\?>/i,a);s=s.replace(/<\?\s*echo\s*SITE_TEMPLATE_PATH;?\s*\?>/i,a)}}return s});return i},ParseBreak:function(e){var t=this;e=e.replace(/<break\s*\/*>/gi,function(e){return t.GetSurrogateHTML("pagebreak",BX.message("BXEdPageBreakSur"),BX.message("BXEdPageBreakSurTitle"))});return e},GetSiteTemplatePath:function(){return this.editor.GetTemplateParams().SITE_TEMPLATE_PATH},CustomContentParse:function(e){for(var t=0;t<this.customParsers.length;t++){if(typeof this.customParsers[t]=="function"){e=this.customParsers[t](e)}}return e},AddCustomParser:function(e){if(typeof e=="function")this.customParsers.push(e)}};function r(e){this.editor=e;this.parseAlign=true}r.prototype={Unparse:function(e){var t=this.editor.parser.GetAsDomElement(e,this.editor.GetIframeDoc());t.setAttribute("data-bx-parent-node","Y");e=this.GetNodeHtml(t,true);e=e.replace(/#BR#/gi,"\n");e=e.replace(/&nbsp;/gi," ");e=e.replace(/\uFEFF/gi,"");return e},Parse:function(e){var t=this,r,i;e=e.replace(/</gi,"&lt;");e=e.replace(/>/gi,"&gt;");function s(e){if(!e.replace)return e;return e.replace(/("|<|>)/g,"")}var a=[];e=e.replace(/\[code\]((?:\s|\S)*?)\[\/code\]/gi,function(e,t){a.push('<pre class="bxhtmled-code">'+t+"</pre>");return"#BX_CODE"+(a.length-1)+"#"});var n,o;for(n in this.editor.parser.specialParsers){if(this.editor.parser.specialParsers.hasOwnProperty(n)){o=this.editor.parser.specialParsers[n];if(o&&o.Parse){e=o.Parse(n,e,this.editor)}}}if(this.editor.sortedSmiles){var l=[],d=[],u;e=e.replace(/\[(?:\s|\S)*?\]/gi,function(e){d.push(e);return"#BX_TMP_TAG"+(d.length-1)+"#"});e=e.replace(/(?:https?|ftp):\/\//gi,function(e){l.push(e);return"#BX_TMP_URL"+(l.length-1)+"#"});i=this.editor.sortedSmiles.length;for(r=0;r<i;r++){u=this.editor.sortedSmiles[r];if(u.path&&u.code){e=e.replace(new RegExp(BX.util.preg_quote(u.code),"ig"),'<img id="'+t.editor.SetBxTag(false,{tag:"smile",params:u})+'" src="'+u.path+'" title="'+(u.name||u.code)+'"/>')}}if(l.length>0){e=e.replace(/#BX_TMP_URL(\d+)#/gi,function(e,t){return l[t]||e})}if(d.length>0){e=e.replace(/#BX_TMP_TAG(\d+)#/gi,function(e,t){return d[t]||e})}}e=e.replace(/\[quote\]/gi,'<blockquote class="bxhtmled-quote">');e=e.replace(/\[\/quote\]\n?/gi,"</blockquote>");e=e.replace(/[\r\n\s\t]?\[table\][\r\n\s\t]*?\[tr\]/gi,'<table border="1">[TR]');e=e.replace(/\[tr\][\r\n\s\t]*?\[td\]/gi,"[TR][TD]");e=e.replace(/\[tr\][\r\n\s\t]*?\[th\]/gi,"[TR][TH]");e=e.replace(/\[\/td\][\r\n\s\t]*?\[td\]/gi,"[/TD][TD]");e=e.replace(/\[\/tr\][\r\n\s\t]*?\[tr\]/gi,"[/TR][TR]");e=e.replace(/\[\/td\][\r\n\s\t]*?\[\/tr\]/gi,"[/TD][/TR]");e=e.replace(/\[\/th\][\r\n\s\t]*?\[\/tr\]/gi,"[/TH][/TR]");e=e.replace(/\[\/tr\][\r\n\s\t]*?\[\/table\][\r\n\s\t]?/gi,"[/TR][/TABLE]");e=e.replace(/[\r\n\s\t]*?\[\/list\]/gi,"[/LIST]");e=e.replace(/[\r\n\s\t]*?\[\*\]?/gi,"[*]");var h=["b","u","i",["s","del"],"table","tr","td","th"],c,f;i=h.length;for(r=0;r<i;r++){if(typeof h[r]=="object"){c=h[r][0];f=h[r][1]}else{c=f=h[r]}e=e.replace(new RegExp("\\[(\\/?)"+c+"\\]","ig"),"<$1"+f+">")}e=e.replace(/\[url\]((?:\s|\S)*?)\[\/url\]/gi,function(e,t){return'<a href="'+s(t)+'">'+t+"</a>"});e=e.replace(/\[url\s*=\s*((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/url\]/gi,function(e,t,r){return'<a href="'+s(t)+'">'+r+"</a>"});e=e.replace(/\[img((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/img\]/gi,function(e,r,i){r=t.FetchImageParams(r);i=s(i);var a="";if(r.width)a+="width:"+parseInt(r.width)+"px;";if(r.height)a+="height:"+parseInt(r.height)+"px;";if(a!=="")a='style="'+a+'"';return'<img  src="'+i+'"'+a+"/>"});r=0;while(e.toLowerCase().indexOf("[color=")!=-1&&e.toLowerCase().indexOf("[/color]")!=-1&&r++<20){e=e.replace(/\[color=((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/color\]/gi,function(e,t,r){return'<span style="color:'+s(t)+'">'+r+"</span>"})}r=0;while(e.toLowerCase().indexOf("[list=")!=-1&&e.toLowerCase().indexOf("[/list]")!=-1&&r++<20){e=e.replace(/\[list=1\]((?:\s|\S)*?)\[\/list\]/gi,"<ol>$1</ol>")}r=0;while(e.toLowerCase().indexOf("[list")!=-1&&e.toLowerCase().indexOf("[/list]")!=-1&&r++<20){e=e.replace(/\[list\]((?:\s|\S)*?)\[\/list\]/gi,"<ul>$1</ul>")}e=e.replace(/\[\*\]/gi,"<li>");r=0;while(e.toLowerCase().indexOf("[font=")!=-1&&e.toLowerCase().indexOf("[/font]")!=-1&&r++<20){e=e.replace(/\[font=((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/font\]/gi,function(e,t,r){return'<span style="font-family:'+s(t)+'">'+r+"</span>"})}r=0;while(e.toLowerCase().indexOf("[size=")!=-1&&e.toLowerCase().indexOf("[/size]")!=-1&&r++<20){e=e.replace(/\[size=((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/size\]/gi,function(e,t,r){return'<span style="font-size:'+s(t)+'">'+r+"</span>"})}if(this.parseAlign){e=e.replace(/\[(center|left|right|justify)\]/gi,function(e,t){return'<div style="text-align:'+s(t)+'">'});e=e.replace(/\[\/(center|left|right|justify)\]/gi,"</div>")}if(e.toLowerCase().indexOf("[/video]")!=-1){e=e.replace(/\[video((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/video\]/gi,function(e,r,i){return t.GetVideoSourse(i,t.FetchVideoParams(r.trim(r)),e)})}e=e.replace(/\n/gi,"<br />");e=e.replace(/&#91;/gi,"[");e=e.replace(/&#93;/gi,"]");if(a.length>0){e=e.replace(/#BX_CODE(\d+)#/gi,function(e,t){return a[t]||e})}return e},GetNodeHtml:function(e,t){var r={node:e},i="";if(!t){if(e.nodeType==3){var s=BX.util.htmlspecialchars(e.nodeValue);if(!s.match(/[^\n]+/gi)&&e.previousSibling&&e.nextSibling&&this.editor.util.IsBlockNode(e.previousSibling)&&this.editor.util.IsBlockNode(e.nextSibling)){return"\n"}if(BX.browser.IsChrome()&&this.editor.pasteHandleMode&&e.nextSibling&&e.nextSibling.nodeName=="P"){s=s.replace(/\n+/gi,"\n")}if(e.parentNode&&!e.parentNode.getAttribute("data-bx-parent-node")&&BX.util.in_array(e.parentNode.nodeName,["P","DIV","SPAN","TD","TH","B","STRONG","I","EM","U","DEL","S","STRIKE"])){s=s.replace(/\n/gi," ")}s=s.replace(/\[/gi,"&#91;");s=s.replace(/\]/gi,"&#93;");return s}if(e.nodeType==1&&e.nodeName=="P"){var a=BX.util.trim(e.innerHTML);a=a.replace(/[\n\r\s]/gi,"").toLowerCase();if(a=="<br>"){e.innerHTML=""}}var n=this.UnParseNodeBB(r);if(n!==false){return n}if(r.bbOnlyChild)t=true;if(!t){if(r.breakLineBefore){i+="\n"}if(e.nodeType==1&&!r.hide){i+="["+r.bbTag;if(r.bbValue){i+="="+r.bbValue}i+="]"}}}if(r.checkNodeAgain){i+=this.GetNodeHtml(e)}else{var o,l,d="";for(o=0;o<e.childNodes.length;o++){l=e.childNodes[o];d+=this.GetNodeHtml(l)}i+=d}if(!t){if(r.breakLineAfter)i+="\n";if(d==""&&this.IsPairNode(r.bbTag)&&e.nodeName!=="P"&&e.nodeName!=="TD"&&e.nodeName!=="TR"&&e.nodeName!=="TH"){return""}if(e.nodeType==1&&(e.childNodes.length>0||this.IsPairNode(r.bbTag))&&!r.hide&&!r.hideRight){i+="[/"+r.bbTag+"]"}if(r.breakLineAfterEnd||e.nodeType==1&&this.editor.util.IsBlockNode(e)&&this.editor.util.IsBlockNode(e.nextSibling)){i+="\n"}}return i},UnParseNodeBB:function(e){var t,r=["TABLE","TD","TR","TH","TBODY","TFOOT","THEAD","CAPTION","COL","COLGROUP"],i=false,s=false,a=e.node.nodeName.toUpperCase();e.checkNodeAgain=false;if(a=="BR"){return"#BR#"}if(e.node&&e.node.id){t=this.editor.GetBxTag(e.node.id);if(t.tag){var n=this.editor.parser.specialParsers[t.tag];if(n&&n.UnParse){return n.UnParse(t,e,this.editor)}else if(t.tag=="video"){return t.params.value}else if(t.tag=="smile"){return t.params.code}else{return""}}}if(a=="IFRAME"&&e.node.src){var o=e.node.src.replace(/https?:\/\//gi,"//"),l=this.editor.phpParser.CheckForVideo('src="'+o+'"');if(l){var d=parseInt(e.node.width),u=parseInt(e.node.height);return"[VIDEO TYPE="+l.provider.toUpperCase()+" WIDTH="+d+" HEIGHT="+u+"]"+o+"[/VIDEO]"}}if(a=="PRE"&&BX.hasClass(e.node,"bxhtmled-code")){return"[CODE]"+this.GetCodeContent(e.node)+"[/CODE]"}if(a=="IMG"){var h="";if(e.node.style.width)h+=" WIDTH="+parseInt(e.node.style.width);else if(e.node.width)h+=" WIDTH="+parseInt(e.node.width);if(e.node.style.height)h+=" HEIGHT="+parseInt(e.node.style.height);else if(e.node.height)h+=" HEIGHT="+parseInt(e.node.height);return"[IMG"+h+"]"+e.node.src+"[/IMG]"}e.hide=false;e.bbTag=a;i=BX.util.in_array(a,r);s=this.parseAlign&&(e.node.style.textAlign||e.node.align)&&!i;if(a=="STRONG"||a=="B"){e.bbTag="B"}else if(a=="EM"||a=="I"){e.bbTag="I"}else if(a=="DEL"||a=="S"){e.bbTag="S"}else if(a=="OL"||a=="UL"){e.bbTag="LIST";e.breakLineAfter=true;e.bbValue=a=="OL"?"1":""}else if(a=="LI"){e.bbTag="*";e.breakLineBefore=true;e.hideRight=true}else if(a=="A"){e.bbTag="URL";e.bbValue=this.editor.parser.GetAttributeEx(e.node,"href");e.bbValue=e.bbValue.replace(/\[/gi,"&#91;").replace(/\]/gi,"&#93;");if(e.bbValue===""){e.bbOnlyChild=true}}else if(e.node.style.color&&!i){e.bbTag="COLOR";e.bbValue=this.editor.util.RgbToHex(e.node.style.color);e.node.style.color="";if(e.node.style.cssText!=""){e.checkNodeAgain=true}}else if(e.node.style.fontFamily&&!i){e.bbTag="FONT";e.bbValue=e.node.style.fontFamily;e.node.style.fontFamily="";if(e.node.style.cssText!=""){e.checkNodeAgain=true}}else if(e.node.style.fontSize&&!i){e.bbTag="SIZE";e.bbValue=e.node.style.fontSize;e.node.style.fontSize="";if(e.node.style.cssText!=""){e.checkNodeAgain=true}}else if(a=="BLOCKQUOTE"&&e.node.className=="bxhtmled-quote"&&!e.node.getAttribute("data-bx-skip-check")){e.bbTag="QUOTE";e.breakLineAfterEnd=true;if(s){e.checkNodeAgain=true;e.node.setAttribute("data-bx-skip-check","Y")}}else if(s){var c=e.node.style.textAlign||e.node.align;if(BX.util.in_array(c,["left","right","center","justify"])){e.hide=false;e.bbTag=c.toUpperCase()}else{e.hide=!BX.util.in_array(a,this.editor.BBCODE_TAGS)}}else if(!BX.util.in_array(a,this.editor.BBCODE_TAGS)){e.hide=true}return false},IsPairNode:function(e){e=e.toUpperCase();return!(e.substr(0,1)=="H"||e=="BR"||e=="IMG"||e=="INPUT")},GetCodeContent:function(e){if(!e||this.editor.util.IsEmptyNode(e))return"";var t,r="";for(t=0;t<e.childNodes.length;t++){if(e.childNodes[t].nodeType==3)r+=e.childNodes[t].data;else if(e.childNodes[t].nodeType==1&&e.childNodes[t].nodeName=="BR")r+="#BR#";else r+=this.GetCodeContent(e.childNodes[t])}if(BX.browser.IsIE())r=r.replace(/\r/gi,"#BR#");else r=r.replace(/\n/gi,"#BR#");r=r.replace(/\[/gi,"&#91;");r=r.replace(/\]/gi,"&#93;");return r},GetVideoSourse:function(e,t,r){return this.editor.phpParser.GetVideoHTML({params:{width:t.width,height:t.height,title:BX.message.BXEdVideoTitle,origTitle:"",provider:t.type},html:r})},FetchVideoParams:function(e){e=BX.util.trim(e);var t=e.split(" "),r,i,s,a,n={width:180,height:100,type:false};for(r=0;r<t.length;r++){a=t[r].split("=");i=a[0].toLowerCase();s=a[1];if(i=="width"||i=="height"){s=parseInt(s,10);if(s&&!isNaN(s)){n[i]=Math.max(s,100)}}else if(i=="type"){s=s.toUpperCase();if(s=="YOUTUBE"||s=="RUTUBE"||s=="VIMEO"){n[i]=s}}}return n},FetchImageParams:function(e){e=BX.util.trim(e);var t=e.split(" "),r,i,s,a,n={};for(r=0;r<t.length;r++){a=t[r].split("=");i=a[0].toLowerCase();s=a[1];if(i=="width"||i=="height"){s=parseInt(s,10);if(s&&!isNaN(s)){n[i]=s}}}return n}};function i(e){this.editor=e;var t=["area","hr","i?frame","link","meta","noscript","style","table","tbody","thead","tfoot"],r=["li","dt","dd","h[1-6]","option","script"];this.reBefore=new RegExp("^<(/?"+t.join("|/?")+"|"+r.join("|")+")[ >]","i");this.reAfter=new RegExp("^<(br|/?"+t.join("|/?")+"|/"+r.join("|/")+")[ >]");var i=["blockquote","div","dl","fieldset","form","frameset","map","ol","p","pre","select","td","th","tr","ul"];this.reLevel=new RegExp("^</?("+i.join("|")+")[ >]");this.lastCode=null;this.lastResult=null}i.prototype={Format:function(e){if(e!=this.lastCode){this.lastCode=e;this.lastResult=this.DoFormat(e)}return this.lastResult},DoFormat:function(e){e+=" ";this.level=0;var t,r,i=0,s=null,a=null,n="",o="",l="";for(t=0;t<e.length;t++){i=t;if(e.substr(t).indexOf("<")==-1){o+=e.substr(t);o=o.replace(/\n\s*\n/g,"\n");o=o.replace(/^[\s\n]*/,"");o=o.replace(/[\s\n]*$/,"");if(o.indexOf("<!--noindex-->")!==-1){o=o.replace(/(<!--noindex-->)(?:[\s|\n|\r|\t]*?)(<a[\s\S]*?\/a>)(?:[\s|\n|\r|\t]*?)(<!--\/noindex-->)(?:[\n|\r|\t]*)/gi,"$1$2$3")}return o}while(i<e.length&&e.charAt(i)!=="<"){i++}if(t!=i){l=e.substr(t,i-t);if(l.match(/^\s+$/)){l=l.replace(/\s+/g," ");o+=l}else{if(o.charAt(o.length-1)=="\n"){o+=this.GetTabs()}else if(l.charAt(0)=="\n"){o+="\n"+this.GetTabs();l=l.replace(/^\s+/,"")}l=l.replace(/\n/g," ");l=l.replace(/\n+/g,"");l=l.replace(/\s+/g," ");o+=l}if(l.match(/\n/)){o+="\n"+this.GetTabs()}}s=i;while(i<e.length&&e.charAt(i)!=">"){i++}n=e.substr(s,i-s);t=i;if(n.substr(1,3)==="!--"){if(!n.match(/--$/)){while(e.substr(i,3)!=="-->"){i++}i+=2;n=e.substr(s,i-s);t=i}if(o.charAt(o.length-1)!=="\n"){o+="\n"}o+=this.GetTabs();o+=n+">\n"}else if(n[1]==="!"){o=this.PutTag(n+">",o)}else if(n[1]=="?"){o+=n+">\n"}else if(r=n.match(/^<(script|style)/i)){r[1]=r[1].toLowerCase();o=this.PutTag(this.CleanTag(n),o);a=String(e.substr(t+1)).toLowerCase().indexOf("</"+r[1]);if(a){l=e.substr(t+1,a);t+=a;o+=l}}else{o=this.PutTag(this.CleanTag(n),o)}}return e},GetTabs:function(){var e="",t;for(t=0;t<this.level;t++){e+="	"}return e},CleanTag:function(e){var t,r=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/,i="",s="";e=e.replace(/\n/g," ");e=e.replace(/[\s]{2,}/g," ");e=e.replace(/^\s+|\s+$/g," ");if(e.match(/\/$/)){s="/";e=e.replace(/\/+$/,"")}while(t=r.exec(e)){if(t[2])i+=t[1]+"="+t[2];else if(t[1])i+=t[1];i+=" ";e=e.substr(t[0].length)}return i.replace(/\s*$/,"")+s+">"},PutTag:function(e,t){var r=e.match(this.reLevel);if(e.match(this.reBefore)||r){t=t.replace(/\s*$/,"");t+="\n"}if(r&&e.charAt(1)=="/"){this.level--}if(t.charAt(t.length-1)=="\n"){t+=this.GetTabs()}if(r&&"/"!=e.charAt(1)){this.level++}t+=e;if(e.match(this.reAfter)||e.match(this.reLevel)){t=t.replace(/ *$/,"");t+="\n"}return t}};function s(){window.BXHtmlEditor.BXCodeFormatter=i;window.BXHtmlEditor.BXEditorParser=e;window.BXHtmlEditor.BXEditorPhpParser=t;window.BXHtmlEditor.BXEditorBbCodeParser=r}if(window.BXHtmlEditor){s()}else{BX.addCustomEvent(window,"OnBXHtmlEditorInit",s)}})();
//# sourceMappingURL=html-parser.map.js