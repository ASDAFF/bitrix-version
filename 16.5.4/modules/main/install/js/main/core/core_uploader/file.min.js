(function(e){if(e.BX["UploaderFile"])return false;var t=e.BX,i={"new":0,ready:1,preparing:2,inprogress:3,done:4,failed:5,stopped:6,changed:7,uploaded:8},s=function(e){this.timeLimit=typeof e=="number"&&e>0?e:50;this.status=i.ready;this.queue=new t.UploaderUtils.Hash};s.prototype={image:null,getImage:function(){if(!this.image)this.image=new Image;return this.image},canvas:null,getCanvas:function(){if(!this.canvas)this.canvas=t.create("CANVAS");return this.canvas},context:null,getContext:function(){if(!this.context&&this.getCanvas()["getContext"])this.context=this.getCanvas().getContext("2d");return this.context},reader:null,getReader:function(){if(!this.reader&&e["FileReader"])this.reader=new FileReader;return this.reader},load:function(i,s,a,h){var n=this.getImage();t.unbindAll(n);this.onload=null;delete this.onload;this.onerror=null;delete this.onerror;n.src="/bitrix/images/1.gif";this.onload=t.delegate(function(){if(!!s){try{s(t.proxy_context,this.getCanvas(),this.getContext())}catch(e){t.debug(e)}}if(!!a){this.queue.removeItem(a);setTimeout(t.proxy(this.exec,this),this.timeLimit)}},this);this.onerror=t.delegate(function(){if(!!h){try{h(t.proxy_context)}catch(e){t.debug(e)}}if(!!a){this.queue.removeItem(a);setTimeout(t.proxy(this.exec,this),this.timeLimit)}},this);n.name=i.name;t.bind(n,"load",this.onload);t.bind(n,"error",this.onerror);var r=Object.prototype.toString.call(i);if(i["tmp_url"]){n.src=i["tmp_url"]}else if(r!=="[object File]"&&r!=="[object Blob]"){this.onerror(null)}else if(!!e["URL"]){n.src=e["URL"]["createObjectURL"](i)}else if(this.getReader()!==null){this.__readerOnLoad=t.delegate(function(e){n.src=e.target.result;this.__readerOnLoad=null;delete this.__readerOnLoad},this);this.getReader().onload=this.__readerOnLoad;this.getReader().readAsDataURL(i)}},push:function(e,i,s){var a=t.UploaderUtils.getId();this.queue.setItem(a,[a,e,i,s]);this.exec()},exec:function(){var e=this.queue.getFirst();if(!!e)this.load(e[1],e[2],e[0],e[3])}};t.UploaderFileCnvConstr=s;var a=function(e){this.timeLimit=typeof e=="number"&&e>0?e:50;this.status=i.ready;this.queue=new t.UploaderUtils.Hash;this._exec=t.delegate(this.exec,this)};a.prototype={xhr:null,goToNext:function(e){delete this.xhr;this.xhr=null;this.queue.removeItem(e);this.status=i.ready;setTimeout(this._exec,this.timeLimit)},load:function(e,s,a,h){if(this.status!=i.ready)return;this.status=i.inprogress;var n=this;this.xhr=t.ajax({method:"GET",data:"",url:s,onsuccess:function(t){if(t===null){h(t)}else{a(t)}n.goToNext(e)},onfailure:function(t){h(t);n.goToNext(e)},start:false,preparePost:false,processData:false});this.xhr.withCredentials=true;this.xhr.responseType="blob";this.xhr.send()},push:function(e,i,s){var a=t.UploaderUtils.getId();this.queue.setItem(a,[a,e,i,s]);this.exec()},exec:function(){var e=this.queue.getFirst();if(!!e)this.load(e[0],e[1],e[2],e[3])}};t.UploaderFileFileLoader=a();var h=new s,n=new s,r=new s,l=t.create("CANVAS"),o;var d={};t.UploaderFile=function(e,s,a,h){this.dialogName=this.dialogName?this.dialogName:"BX.UploaderFile";this.file=e;this.id=e["id"]||"file"+t.UploaderUtils.getId();this.name=e.name;this.isNode=false;if(t.type.isDomNode(e)){this.isNode=true;this.name=t.UploaderUtils.getFileNameOnly(e.value);if(/\[(.+?)\]/.test(e.name)){var n=/\[(.+?)\]/.exec(e.name);this.id=n[1]}this.file.bxuHandler=this}else if(e["tmp_url"]&&!e["name"]){this.name=t.UploaderUtils.getFileNameOnly(e["tmp_url"])}this.preview='<span id="'+this.id+'Canvas" class="bx-bxu-canvas"></span>';this.nameWithoutExt=this.name.lastIndexOf(".")>0?this.name.substr(0,this.name.lastIndexOf(".")):this.name;this.ext=this.name.substr(this.nameWithoutExt.length+1);if(/iPhone|iPad|iPod/i.test(navigator.userAgent)&&this.nameWithoutExt=="image"){var r="mobile_"+t.date.format("Ymd_His");d[r]=d[r]||0;this.nameWithoutExt=r+(d[r]>0?"_"+d[r]:"");this.name=this.nameWithoutExt+(t.type.isNotEmptyString(this.ext)?"."+this.ext:"");d[r]++}this.size="";if(e.size)this.size=t.UploaderUtils.getFormattedSize(e.size,0);this.type=e.type;this.status=i["new"];this.limits=a;this.caller=h;this.fields={thumb:{tagName:"SPAN",template:'<div class="someclass">#preview#<div>#name#</div>',editorTemplate:'<div class="someeditorclass"><div>#name#</div>',className:"bx-bxu-thumb-thumb",placeHolder:null},preview:{params:{width:400,height:400},template:"#preview#",editorParams:{width:1024,height:860},editorTemplate:"<span>#preview#</span>",className:"bx-bxu-thumb-preview",placeHolder:null,events:{click:t.delegate(this.clickFile,this)}},name:{template:"#name#",editorTemplate:'<span><input type="text" name="name" value="#name#" /></span>',className:"bx-bxu-thumb-name",placeHolder:null},type:{template:"#type#",editorTemplate:"#type#",className:"bx-bxu-thumb-type",placeHolder:null}};if(!!s["fields"]){var l,o;for(var m in s["fields"]){if(s["fields"].hasOwnProperty(m)){if(!!this.fields[m]){for(l in s["fields"][m]){if(s["fields"][m].hasOwnProperty(l)){this.fields[m][l]=s["fields"][m][l]}}}else this.fields[m]=s["fields"][m];o=m+"";if(o.toLowerCase()!="thumb"&&o.toLowerCase()!="preview"){this[o.toLowerCase()]=!!s["fields"][m]["value"]?s["fields"][m]["value"]:"";this.log(o.toLowerCase()+": "+this[o.toLowerCase()])}}}}t.onCustomEvent(this,"onFileIsCreated",[this.id,this,this.caller]);t.onCustomEvent(this.caller,"onFileIsCreated",[this.id,this,this.caller]);this.makePreview();this.preparationStatus=i.done;return this};t.UploaderFile.prototype={log:function(e){t.UploaderUtils.log("file "+this.name,e)},makeThumb:function(){var e=this.fields.thumb.template,i,s,a={},h,n;for(s in this.fields){if(this.fields.hasOwnProperty(s)){if(this.fields[s].template&&this.fields[s].template.indexOf("#"+s+"#")>=0){i=this.id+s.toUpperCase().substr(0,1)+s.substr(1);h=this.setProps(s,this[s],true);e=e.replace("#"+s+"#",'<span id="'+i+'" class="'+this.fields[s]["className"]+'">'+(t.type.isNotEmptyString(h.html)?h.html.replace("#","<>"):h.html)+"</span>");for(n in h.events){if(h.events.hasOwnProperty(n)){a[n]=h.events[n]}}if(!!this.fields[s].events)a[i]=this.fields[s].events}}}var r,l=[],o=[],d;while((r=/#(.+?)#/gi.exec(e))&&!!r){if(this[r[1]]!==undefined){e=e.replace(r[0],t.type.isNotEmptyString(this[r[1]])?this[r[1]].replace("#","<>"):this[r[1]])}else{d="<"+l.length+">";l.push(d);o.push(r[0]);e=e.replace(r[0],d)}}while((r=l.shift())&&r){d=o.shift();e=e.replace(r,d)}e=e.replace("<>","#");if(!!this.fields.thumb.tagName){r=t.create(this.fields.thumb.tagName,{attrs:{id:this.id+"Thumb",className:this.fields.thumb.className},events:this.fields.thumb.events,html:e})}else{r=e}this.__makeThumbEventsObj=a;this.__makeThumbEvents=t.delegate(function(){var e,i;for(e in a){if(a.hasOwnProperty(e)&&t(e)){for(i in a[e]){if(a[e].hasOwnProperty(i)){t.bind(t(e),i,a[e][i])}}}}this.__makeThumbEvents=null;delete this.__makeThumbEvents},this);t.addCustomEvent(this,"onFileIsAppended",this.__makeThumbEvents);if(t.type.isDomNode(this.file)){if(t.type.isString(e)){this.__bindFileNode=t.delegate(function(e){var i=t(e+"Item");if(i.tagName=="TR")i.cells[0].appendChild(this.file);else if(i.tagName=="TABLE")i.rows[0].cells[0].appendChild(this.file);else t(e+"Item").appendChild(this.file);this.__bindFileNode=null;delete this.__bindFileNode},this);t.addCustomEvent(this,"onFileIsAppended",this.__bindFileNode)}else{r.appendChild(this.file)}}return r},checkProps:function(){var e=t.UploaderUtils.FormToArray({elements:[t.proxy_context]}),i;for(i in e.data){if(e.data.hasOwnProperty(i))this[i]=e.data[i]}},setProps:function(e,i,s){if(typeof e=="string"){if(e=="size")i=t.UploaderUtils.getFormattedSize(this.file.size,0);if(typeof this[e]!="undefined"&&typeof this.fields[e]!="undefined"){this[e]=i;var a=this.fields[e].template.replace("#"+e+"#",!!i?i:"").replace(/#id#/gi,this.id),h,n,r,l={html:a,events:{}};this.hiddenForm=!!this.hiddenForm?this.hiddenForm:t.create("FORM",{style:{display:"none"}});this._checkProps=!!this._checkProps?this._checkProps:t.delegate(this.checkProps,this);this.hiddenForm.innerHTML=a;if(this.hiddenForm.elements.length>0){for(h=0;h<this.hiddenForm.elements.length;h++){r=this.hiddenForm.elements[h];if(typeof this[r.name]!="undefined"){if(!r.hasAttribute("id"))r.setAttribute("id",this.id+e+t.UploaderUtils.getId());l.events[r.id]={blur:this._checkProps}}}l.html=this.hiddenForm.innerHTML}if(t(this.hiddenForm))t.remove(this.hiddenForm);this.hiddenForm=null;delete this.hiddenForm;if(s)return l;var o=this.getPH(e);if(!!o){o.innerHTML=l.html;for(h in l.events){if(l.events.hasOwnProperty(h)){for(n in l.events[h]){if(l.events[h].hasOwnProperty(n)){t.bind(t(h),n,l.events[h][n])}}}}}}}else if(!!e){for(var d in e){if(e.hasOwnProperty(d)){if(this.fields.hasOwnProperty(d)&&d!=="preview")this.setProps(d,e[d])}}}return true},getProps:function(e){if(e=="canvas"){return t(this.id+"ProperCanvas")}else if(typeof e=="string"){return this[e]}var i={};for(var s in this.fields){if(this.fields.hasOwnProperty(s)&&(s!=="preview"&&s!=="thumb")){i[s]=this[s]}}if(!!this.copies){var a;i["canvases"]={};while((a=this.copies.getNext())&&!!a){i["canvases"][a.id]={width:a.width,height:a.height,name:a.name}}}return i},getThumbs:function(){return null},getPH:function(e){e=typeof e==="string"?e:"";e=e.toLowerCase();if(this.fields.hasOwnProperty(e)){var i=e.substr(0,1).toUpperCase()+e.substr(1);this.fields[e]["placeHolder"]=t(this.id+i);return this.fields[e]["placeHolder"]}return null},clickFile:function(){return false},makePreview:function(){this.status=i.ready;t.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);t.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized as a file")},preparationStatus:i.ready,deleteFile:function(){var e,i=this.__makeThumbEventsObj;for(e in this.fields){if(this.fields.hasOwnProperty(e)){if(!!this.fields[e]["placeHolder"]){this.fields[e]["placeHolder"]=null;t.unbindAll(this.fields[e]["placeHolder"]);delete this.fields[e]["placeHolder"]}}}for(e in i){if(i.hasOwnProperty(e)&&t(e)){t.unbindAll(t(e))}}this.file=null;delete this.file;t.remove(this.canvas);this.canvas=null;delete this.canvas;t.onCustomEvent(this.caller,"onFileIsDeleted",[this.id,this,this.caller]);t.onCustomEvent(this,"onFileIsDeleted",[this,this.caller])}};t.UploaderImage=function(e,s,a,h){this.dialogName="BX.UploaderImage";t.UploaderImage.superclass.constructor.apply(this,arguments);this.isImage=true;this.copies=new t.UploaderUtils.Hash;this.caller=h;if(!this.isNode&&t.Uploader.getInstanceName()=="BX.Uploader"){if(!!s["copies"]){var r=s["copies"],l;for(var o in r){if(r.hasOwnProperty(o)&&!!r[o]){l={width:parseInt(r[o]["width"]),height:parseInt(r[o]["height"]),id:o};if(l["width"]>0&&l["height"]>0){this.copies.setItem(o,l)}}}}this.preparationStatus=i["new"];t.addCustomEvent(this,"onFileHasToBePrepared",t.delegate(function(){this.preparationStatus=i.inprogress;if(this.status!=i["new"]){n.push(this.file,t.delegate(this.makeCopies,this))}},this));t.addCustomEvent(this,"onUploadDone",t.delegate(function(){var e;while((e=this.copies.getNext())&&!!e){e.file=null;delete e.file}this.preparationStatus=i["new"]},this));this.canvas=t.create("CANVAS",{attrs:{id:this.id+"ProperCanvas"}})}else{this.preparationStatus=i.done;this.canvas=null}return this};t.extend(t.UploaderImage,t.UploaderFile);t.UploaderImage.prototype.makePreviewImageWork=function(e){var i=null;if(this.file){this.file.width=e.width;this.file.height=e.height}if(!!this.canvas){t.adjust(h.getCanvas(),{props:{width:e.width,height:e.height}});h.getContext().drawImage(e,0,0);this.applyFile(h.getCanvas(),false);i=this.canvas}else if(t(this.id+"Canvas")){var s=t.UploaderUtils.scaleImage(e,this.fields.preview.params),a={props:{width:s.destin.width,height:s.destin.height,src:e.src},attrs:{className:this.file.width>this.file.height?"landscape":"portrait"}};i=t.create("IMG",a)}t.onCustomEvent(this,"onFileCanvasIsLoaded",[this.id,this,this.caller,e]);t.onCustomEvent(this.caller,"onFileCanvasIsLoaded",[this.id,this,this.caller,e]);if(t(this.id+"Canvas"))t(this.id+"Canvas").appendChild(i);return i};t.UploaderImage.prototype.makePreviewImageLoadHandler=function(e,s,a){this.makePreviewImageWork(e);this.status=i.ready;t.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);t.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized as an image with preview");if(this.preparationStatus==i.inprogress)this.makeCopies(e,s,a);if(this["_makePreviewImageLoadHandler"]){this._makePreviewImageLoadHandler=null;delete this._makePreviewImageLoadHandler}if(this["_makePreviewImageFailedHandler"]){this._makePreviewImageFailedHandler=null;delete this._makePreviewImageFailedHandler}};t.UploaderImage.prototype.makePreviewImageFailedHandler=function(){this.status=i.ready;this.preparationStatus=i.done;t.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);t.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized without canvas");if(this["_makePreviewImageLoadHandler"]){this._makePreviewImageLoadHandler=null;delete this._makePreviewImageLoadHandler}if(this["_makePreviewImageFailedHandler"]){this._makePreviewImageFailedHandler=null;delete this._makePreviewImageFailedHandler}};t.UploaderImage.prototype.makePreview=function(){if(!this.isNode){this._makePreviewImageLoadHandler=t.delegate(this.makePreviewImageLoadHandler,this);this._makePreviewImageFailedHandler=t.delegate(this.makePreviewImageFailedHandler,this);h.push(this.file,this._makePreviewImageLoadHandler,this._makePreviewImageFailedHandler)}else{this.status=i.ready;t.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);t.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized as an image without preview");if(this.caller.queue.placeHolder){this._onFileHasGotPreview=t.delegate(function(e,i){t.removeCustomEvent(this,"onFileHasGotPreview",this._onFileHasGotPreview);t.removeCustomEvent(this,"onFileHasNotGotPreview",this._onFileHasNotGotPreview);this._makePreviewImageLoadHandler=t.delegate(function(e){e=this.makePreviewImageWork(e);t.onCustomEvent(this,"onFileHasPreview",[i.id,i,e]);delete this._makePreviewImageLoadHandler;delete this._makePreviewImageFailedHandler},this);this._makePreviewImageFailedHandler=t.delegate(function(e){delete this._makePreviewImageLoadHandler;delete this._makePreviewImageFailedHandler},this);h.push({tmp_url:i.file.url},this._makePreviewImageLoadHandler,this._makePreviewImageFailedHandler)},this);this._onFileHasNotGotPreview=t.delegate(function(e){if(e==this.id){t.removeCustomEvent(this,"onFileHasGotPreview",this._onFileHasGotPreview);t.removeCustomEvent(this,"onFileHasNotGotPreview",this._onFileHasNotGotPreview)}},this);t.addCustomEvent(this,"onFileHasGotPreview",this._onFileHasGotPreview);t.addCustomEvent(this,"onFileHasNotGotPreview",this._onFileHasNotGotPreview);t.onCustomEvent(this.caller,"onFileNeedsPreview",[this.id,this,this.caller])}}return true};t.UploaderImage.prototype.checkPreview=function(){};t.UploaderImage.prototype.applyFile=function(e,s){this.checkPreview();if(!!s&&s.data)this.setProps(s.data);var a=t.UploaderUtils.scaleImage(e,{width:this.limits["uploadFileWidth"],height:this.limits["uploadFileHeight"]}),h=t.UploaderUtils.scaleImage(e,this.fields.preview.params),n={props:{width:h.destin.width,height:h.destin.height},attrs:{className:"bx-bxu-proper-canvas"+(h.destin.width>h.destin.height?" landscape":" portrait")}};if(a.bNeedCreatePicture||!!s){t.adjust(l,{props:{width:a.destin.width,height:a.destin.height}});o=l.getContext("2d");o.drawImage(e,a.source.x,a.source.y,a.source.width,a.source.height,a.destin.x,a.destin.y,a.destin.width,a.destin.height);var r=l.toDataURL(this.file.type);this.file=t.UploaderUtils.dataURLToBlob(r)}this.file.name=this.name;this.file.width=a.destin.width;this.file.height=a.destin.height;t.adjust(this.canvas,n);o=this.canvas.getContext("2d");o.drawImage(e,h.source.x,h.source.y,h.source.width,h.source.height,h.destin.x,h.destin.y,h.destin.width,h.destin.height);o=null;e=null;this.setProps("size");this.status=i.changed};t.UploaderImage.prototype.clickFile=function(){if(!this.canvas||!t["CanvasEditor"]||this.status==i["new"])return false;if(!this.__showEditor){this.__showEditor=t.delegate(this.showEditor,this);this.eFunc={apply:t.delegate(this.applyFile,this),"delete":t.delegate(this.deleteFile,this),clear:t.delegate(function(){t.removeCustomEvent(h,"onApplyCanvas",this.eFunc["apply"]);t.removeCustomEvent(h,"onDeleteCanvas",this.eFunc["delete"]);t.removeCustomEvent(h,"onClose",this.eFunc["clear"])},this)}}var e=this.fields.thumb.editorTemplate,s;for(var a in this.fields){if(this.fields.hasOwnProperty(a)){s=a.substr(0,1).toUpperCase()+a.substr(1);e=e.replace("#"+a+"#",a==="preview"?"":'<span id="'+this.id+s+'Editor" class="'+this.fields[a]["className"]+'">'+this.fields[a]["editorTemplate"].replace("#"+a+"#",!!this[a]?this[a]:"")+"</span>")}}t.adjust(r.getCanvas(),{props:{width:this.file.width,height:this.file.height}});r.getContext().drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,r.getCanvas().width,r.getCanvas().height);var h=t.CanvasEditor.show(r.getCanvas(),{title:this.name,template:e});t.addCustomEvent(h,"onApplyCanvas",this.eFunc["apply"]);t.addCustomEvent(h,"onDeleteCanvas",this.eFunc["delete"]);t.addCustomEvent(h,"onClose",this.eFunc["clear"]);t.onCustomEvent(this,"onCanvasEditorIsCreated",[h,this]);r.push(this.file,this.__showEditor);this.editor=h;return false};t.UploaderImage.prototype.showEditor=function(e,i,s){t.adjust(i,{props:{width:this.file.width,height:this.file.height}});s.drawImage(e,0,0);this.editor.copyCanvas(i)};t.UploaderImage.prototype.makeCopies=function(e,s,a){var h,n,r,l;while((h=this.copies.getNext())&&!!h){n=t.UploaderUtils.scaleImage(e,h);t.adjust(s,{props:{width:n.destin.width,height:n.destin.height}});a.drawImage(e,n.source.x,n.source.y,n.source.width,n.source.height,n.destin.x,n.destin.y,n.destin.width,n.destin.height);r=s.toDataURL(this.file.type);l=t.UploaderUtils.dataURLToBlob(r);l.width=s.width;l.height=s.height;l.name=this.name;l.thumb=h.id;l.canvases=this.copies.length;l.canvas=this.copies.pointer-1;h.file=l}this.preparationStatus=i.done};t.UploaderImage.prototype.getThumbs=function(e){if(e=="getCount")return this.copies.length;var t=typeof e=="string"?this.copies.getItem(e):this.copies.getNext();if(!!t)return t.file;return null};return true})(window);
//# sourceMappingURL=file.map.js