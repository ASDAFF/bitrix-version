(function(){if(!window["BX"]||window["BX"]["MPLForm"]||!window["app"])return;var t=window["BX"],e={entityId:0,text:"",form:{},list:{},comments:{}},i=function(t,e){return t+"-"+(e>0?e:"0")};var n=function(i){e.text=t.type.isNotEmptyString(i)?i:"";if(t["localStorage"]&&e.entityId){var n=t.localStorage.get("main.post.list/text");n=n||{};if(t.type.isNotEmptyString(e.text)){n[e.entityId]=e.text}else{delete n[e.entityId]}t.localStorage.set("main.post.list/text",n)}},s=function(e){var i="";if(t["localStorage"]&&e){var n=t.localStorage.get("main.post.list/text");if(n){i=n[e]||"";delete n[e];t.localStorage.set("main.post.list/text",n)}}return i};t.addCustomEvent(window,"OnUCFormSubmit",function(){n("")});t.addCustomEvent("main.post.form/text",function(e){e=t.type.isArray(e)?e[0]:e;n(e)});var o={keyBoardIsShown:false,mention:{}},r=function(t,e,i){if(!!i&&typeof i=="object"){for(var n in i){if(i.hasOwnProperty(n)){r(t,e+"["+n+"]",i[n])}}}else{t.append(e,!!i?i:"")}};window.app.exec("enableCaptureKeyboard",true);t.addCustomEvent("onKeyboardWillShow",function(){o.keyBoardIsShown=true});t.addCustomEvent("onKeyboardDidHide",function(){o.keyBoardIsShown=false});t.addCustomEvent("OnUCCommentWasRead",function(e){var i=t("record-"+e.join("-"));if(i){t.removeClass(i,"post-comment-block-new")}});var a=function(t,e,i){this.id=t;this.text=e||"";this.attachments=i||[];this.mentions={}};a.prototype={text:"",attachments:[],node:null,getText:function(){var t=this.text;for(var e in this.mentions){if(this.mentions.hasOwnProperty(e)){t=t.replace(new RegExp(e,"gi"),this.mentions[e])}}return t}};a.getInstance=function(i,n,s){var o=null;if(!t.type.isArray(i)&&i&&i["___id"]&&e["comments"][i["___id"]]){o=i}else if(e["comments"][i.join("-")]){o=e["comments"][i.join("-")]}else{o=new a(i,n,s);o.___id=i.join("-");e["comments"][i.join("-")]=o}return o};a.removeInstance=function(t){if(t&&t["___id"])delete e["comments"][t["___id"]]};var d=function(i){this.bindEvents();e["form"][this.handlerId]=this;this.entitiesId={};this.comment=null;this.handlerId=i;this.handler=null;this.handlerEvents={onMPFUserIsWriting:t.delegate(this.writing,this),onMPFHasBeenDestroyed:t.delegate(this.reboot,this)};this.visible=false;this.bindHandler=t.delegate(this.bindHandler,this);t.addCustomEvent(window,"onMPFIsInitialized",this.bindHandler);if(t["MPF"])this.bindHandler(t["MPF"].getInstance(this.handlerId))};d.prototype={bindHandler:function(e){if(e&&e.id==this.handlerId){this.handler=e;t.removeCustomEvent(window,"onMPFIsInitialized",this.bindHandler);for(var i in this.handlerEvents){if(this.handlerEvents.hasOwnProperty(i)){t.addCustomEvent(this.handler,i,this.handlerEvents[i])}}this.closeWait();t.onCustomEvent(this,"OnUCFormInit",[this])}},bindEvents:function(){this.windowEvents={OnUCUserReply:t.delegate(function(t,e,i){if(this.entitiesId[t]){var n=[t,0];e=parseInt(e);if(e>0&&i){n=this.initComment(n,"",false);n.mentions[i]="[USER="+e+"]"+i+"[/USER]";var s=this.handler&&this.handler.simpleForm?this.handler.simpleForm.writingParams["~text"]:n.text;n.text=s+(s==""?"":" ")+i+", "}this.show(n,n.text,false)}},this),OnUCAfterRecordEdit:t.delegate(function(t,e,i,n){if(this.entitiesId[t]){if(n==="EDIT"){this.show([t,e],i["messageBBCode"],i["messageFields"])}else if(i["errorMessage"]){this.showError([t,e],i["errorMessage"])}else if(i["okMessage"]){this.showNote([t,e],i["okMessage"])}}},this)};t.addCustomEvent(window,"OnUCUserReply",this.windowEvents.OnUCUserReply);t.addCustomEvent(window,"OnUCAfterRecordEdit",this.windowEvents.OnUCAfterRecordEdit)},reboot:function(e,i,n){for(var s in this.handlerEvents){if(this.handlerEvents.hasOwnProperty(s)){t.removeCustomEvent(this.handler,s,this.handlerEvents[s])}}this.bindHandler(n)},linkEntity:function(i,n){if(this.handler===null){this._linkEntity=t.delegate(function(){this.linkEntity(i,n)},this);t.addCustomEvent(this,"OnUCFormInit",this._linkEntity)}else{if(this["_linkEntity"])t.removeCustomEvent(this,"OnUCFormInit",this["_linkEntity"]);this.entitiesId[i]=n;e.entityId=i;var o=t.proxy(function(t){this.comment=this.reinitComment({id:[i,0],text:t});this.comment.text=t;this.handler.init(this.comment)},this);if(false&&window["platform"]=="ios"){window.BXMobileApp.UI.Page.TextPanel.getText(o)}else{o(s(i))}}},writing:function(e){t.onCustomEvent(window,"OnUCUserIsWriting",[e["id"][0],e["id"][1]])},reinitComment:function(t){var e=[t["id"][0],0],i=t["text"]||"";a.removeInstance(t);return this.initComment(e,i,[])},initComment:function(e,i,n){var s=a.getInstance(e,i,n);if(s["bound"]!=="Y"){t.addCustomEvent(s,"onCancel",t.delegate(t.delegate(this.submitClear,this)));t.addCustomEvent(s,"onStart",t.delegate(t.delegate(this.submitStart,this)));t.addCustomEvent(s,"onSubmit",t.delegate(t.delegate(this.submit,this)));t.addCustomEvent(s,"onError",t.delegate(t.delegate(function(t,e){this.showError(s,e);this.submitClear(s)},this)));s["bound"]="Y"}return s},show:function(i,n,s){this.comment=this.initComment(i,n,s);t.onCustomEvent(this.handler,"OnUCFormBeforeShow",[this,n,s]);e.entityId=i[0];this.handler.show(this.comment,!!s);t.onCustomEvent(this.handler,"OnUCFormAfterShow",[this,n,s]);return true},submitClear:function(t){a.removeInstance(t);if(this.comment==t){this.comment=this.initComment([t.id[0],0],"",[]);e.entityId=t.id[0];this.handler.init(this.comment)}},submitStart:function(e,i,n){t.onCustomEvent(window,"OnUCFormBeforeSubmit",[e.id[0],e.id[1],e,this,i,n])},submit:function(e){var i=e.getText(),n=e.attachments,s=this.entitiesId[e.id[0]],o=this.handler.getForm({ENTITY_XML_ID:e.id[0],REVIEW_TEXT:i,NOREDIRECT:"Y",MODE:"RECORD",AJAX_POST:"Y",id:e.id,sessid:t.bitrix_sessid(),SITE_ID:t.message("SITE_ID"),LANGUAGE_ID:t.message("LANGUAGE_ID")}),a=new window.MobileAjaxWrapper,d=new window.FormData,l;if(e.id[1]>0){o["REVIEW_ACTION"]="EDIT";o["FILTER"]={ID:e.id[1]};if(o["act"]){o["act"]="edit";o["edit_id"]=e.id[1]}}if(s["fields"]){for(l in s["fields"]){if(s["fields"].hasOwnProperty(l)){o[l]=s["fields"][l]}}}t.onCustomEvent(window,"OnUCFormSubmit",[e.id[0],e.id[1],this,o]);for(l in o){if(o.hasOwnProperty(l)){r(d,l,o[l])}}if(n){for(var h=0;h<n.length;h++){r(d,n[h]["fieldName"],n[h]["fieldValue"])}}a.Wrap({method:"POST",url:s["url"],data:{},type:"json",processData:true,start:false,preparePost:false,callback:t.proxy(function(i){t.onCustomEvent(window,"OnUCFormResponse",[e.id[0],e.id[1],this,i,e]);if(i["errorMessage"])this.showError(e,i["errorMessage"]);else t.onCustomEvent(window,"OnUCAfterRecordAdd",[e.id[0],e.id[1],this,i,e])},this),callback_failure:t.delegate(function(i){t.onCustomEvent(window,"OnUCFormResponse",[e.id[0],e.id[1],this,i,e]);this.showError(e,t.message("INCORRECT_SERVER_RESPONSE"))},this)});a.xhr.send(d);this.submitClear(e)},showError:function(e,i){if(t.type.isArray(e))e=this.initComment(e,"",[]);i='<div class="feed-add-info-text"><span class="feed-add-info-icon"></span>'+"<b>"+t.message("FC_ERROR")+"</b><br />"+i+"</div>";if(e&&e.node){t.addClass(e.node,"feed-com-block-cover-undelivered");if(typeof e.attachments=="undefined"||e.attachments.length<=0){t.bind(e.node,"click",t.proxy(function(i){t.unbindAll(e.node);t.removeClass(e.node,"feed-com-block-cover-undelivered");this.handler.comment=e;this.handler.simpleForm.handleAppData(e.text,true)},this))}}else if(i){}},showNote:function(t,e){},showWait:function(){this.handler.hide();this.handler.showWait()},closeWait:function(){this.handler.closeWait()}};d.link=function(t,i){var n=i["id"];e["form"][n]=e["form"][n]||new d(n);e["form"][n].linkEntity(t,i)};window.mobileShowActions=function(n,s,r){r=r||window.event;var a=window.app.enableInVersion(14)&&window.platform=="ios"?window.BXMobileAppContext.isKeyboardShown():o.keyBoardIsShown;if(a){return true}if(r&&r.target&&r.target.tagName&&(r.target.tagName.toUpperCase()=="A"||r.target.tagName.toUpperCase()=="IMG"&&t.type.isNotEmptyString(r.target.getAttribute("data-bx-image")))){return true}t.eventCancelBubble(r);t.PreventDefault(r);var d=t("record-"+i(n,s)),l=[],h;if(d.getAttribute("bx-mpl-reply-show")=="Y")l.push({title:t.message("BLOG_C_REPLY"),callback:function(){e["list"][n].reply(t("record-"+i(n,s)+"-reply-action"))}});var m;if(d.getAttribute("bx-mpl-vote-id")!="#VOTE_ID#"&&window["RatingLikeComments"]&&(m=window.RatingLikeComments.getById(d.getAttribute("bx-mpl-vote-id")))&&m){m["__delegatedVoteFunc"]=m["__delegatedVoteFunc"]||t.delegate(m.vote,m);l.push({title:m.voted?t.message("BPC_MES_VOTE2"):t.message("BPC_MES_VOTE1"),callback:m["__delegatedVoteFunc"]});l.push({title:t.message("BPC_MES_VOTE"),callback:function(){window.RatingLikeComments.List(d.getAttribute("bx-mpl-vote-id"))}})}if(d.getAttribute("bx-mpl-edit-show")=="Y")l.push({title:t.message("BPC_MES_EDIT"),callback:function(){e["list"][n].act(d.getAttribute("bx-mpl-edit-url"),s,"EDIT")}});if(d.getAttribute("bx-mpl-moderate-show")=="Y"){var c=d.getAttribute("bx-mpl-moderate-approved")=="hidden";l.push({title:c?t.message("BPC_MES_SHOW"):t.message("BPC_MES_HIDE"),callback:function(){e["list"][n].act(d.getAttribute("bx-mpl-moderate-url").replace("#action#",c?"show":"hide").replace("#ACTION#",c?"SHOW":"HIDE"),s,"MODERATE")}})}if(d.getAttribute("bx-mpl-delete-show")=="Y")l.push({title:t.message("BPC_MES_DELETE"),callback:function(){e["list"][n].act(d.getAttribute("bx-mpl-delete-url"),s,"DELETE")}});if(l.length>0){h=new window.BXMobileApp.UI.ActionSheet({buttons:l},"commentSheet");h.show()}return false};window.mobileReply=function(i,n){t.eventCancelBubble(n);t.PreventDefault(n);e["list"][i].reply(n.target);return false};window.mobileExpand=function(e,i){t.eventCancelBubble(i);t.PreventDefault(i);var n=t(e)?e.previousSibling:null;if(t(n)){var s=n.parentNode,o=200,r=parseInt(n.offsetHeight),a={height:o},d={height:r};t.remove(e);var l=(r-o)/(2e3-o);l=l<.3?.3:l>.8?.8:l;s.style.maxHeight=a.height+"px";s.style.overflow="hidden";new t["easing"]({duration:l*1e3,start:a,finish:d,transition:t.easing.makeEaseOut(t.easing.transitions.quart),step:function(t){s.style.maxHeight=t.height+"px";s.style.opacity=t.opacity/100},complete:function(){s.style.cssText="";s.style.maxHeight="none";t.onCustomEvent(window,"OnUCRecordWasExpanded",[s]);t.LazyLoad.showImages(true)}}).animate()}return false};var l=function(i){t.MPL=function(n,s,o){t.MPL.superclass.constructor.apply(this,arguments);this.template=t.message("MPL_RECORD_TEMPLATE");this.thumb=t.message("MPL_RECORD_THUMB");this.thumbForFile=t.message("MPL_RECORD_THUMB_FILE");t.removeCustomEvent(i,"OnUCAfterRecordAdd",this.windowEvents["OnUCAfterRecordAdd"]);t.removeCustomEvent(i,"OnUCFormResponse",this.windowEvents["OnUCFormResponse"]);this.postCounter=0;this.windowEvents["OnUCFormBeforeSubmit"]=t.delegate(function(t,e,i,n,s,o){if(this.ENTITY_XML_ID==t){var r=[t,e>0?e:"new_"+this.postCounter++];this.makeThumb(r,i,s,o);this.pullNewRecords[t+"-"+e]="busy"}},this);this.windowEvents["OnUCAfterRecordAdd"]=t.delegate(function(t,e,i,n,s){if(this.ENTITY_XML_ID==t){this.add(s,n["messageId"],n,true,"simple")}},this);this.windowEvents["OnUCFormResponse"]=t.delegate(function(t,e,i,n,s){if(this.ENTITY_XML_ID==t){this.pullNewRecords[t+"-0"]="ready";this.pullNewRecords[t+"-"+e]="done";this.clearThumb(s)}},this);this.windowEvents["onPull"]=t.delegate(function(e){var i=e.params;if(e.module_id=="unicomments"&&e.command=="comment_mobile"&&i["ENTITY_XML_ID"]==this.ENTITY_XML_ID&&i["USER_ID"]+""!=t.message("USER_ID")+""){if(e.command=="comment_mobile"&&i["ID"])this.pullNewRecord(i);else if(e.command=="answer")this.pullNewAuthor(i["USER_ID"],i["NAME"],i["AVATAR"])}},this);t.addCustomEvent(i,"OnUCFormResponse",this.windowEvents["OnUCFormResponse"]);t.addCustomEvent(i,"OnUCAfterRecordAdd",this.windowEvents["OnUCAfterRecordAdd"]);t.addCustomEvent(i,"OnUCFormBeforeSubmit",this.windowEvents["OnUCFormBeforeSubmit"]);t.addCustomEvent(i,"onPull",this.windowEvents["onPull"]);if(s["SHOW_POST_FORM"]=="Y")d.link(this.ENTITY_XML_ID,o);e["list"][this.ENTITY_XML_ID]=this;return this};t.extend(t.MPL,i["FCList"]);t.MPL.prototype.init=function(){};t.MPL.prototype.makeThumb=function(e,n,s,o){var r=n.node||t("record-"+e.join("-")+"-cover");if(!r){var a=t.type.isString(s)?s:"";a=t.util.htmlspecialchars(a).replace(/\n/gi,"<br />");a=a.replace(/\001/,"").replace(/(\[\/user\])/gi,"").replace(/\[user=(\d+)\]([^\001]?.+)(\001)/gi,"$2").replace(/\001/,"[/user]");var d=i.fcParseTemplate({messageFields:{FULL_ID:e,POST_MESSAGE_TEXT:a,POST_TIMESTAMP:(new Date).getTime()/1e3}},{DATE_TIME_FORMAT:this.params.DATE_TIME_FORMAT,RIGHTS:this.rights},t.type.isArray(o)&&o.length>0?this.thumbForFile:this.thumb),l;l=t.processHTML(d,false);r=t.create("DIV",{attrs:{id:"record-"+e.join("-")+"-cover",className:"feed-com-block-cover"},style:{opacity:0,height:0,overflow:"hidden"},html:l.HTML});t("record-"+e[0]+"-new").appendChild(r);var h=r,m=t.pos(h),c=t.GetWindowInnerSize(),u=m.top-c.innerHeight;if(t.GetWindowScrollPos()["scrollTop"]<u)i.scrollTo(0,u);var f=t.GetWindowScrollPos();new t["easing"]({duration:500,start:{opacity:0,height:0},finish:{opacity:100,height:h.scrollHeight},transition:t.easing.makeEaseOut(t.easing.transitions.quart),step:function(t){h.style.height=t.height+"px";h.style.opacity=t.opacity/100;if(f.scrollTop+c.innerHeight<m.top+t.height){i.scrollTo(0,u+t.height)}},complete:function(){if(h.style.display!=="none")h.style.cssText=""}}).animate();var p=0,w=function(){p++;if(p<100){var i=t("record-"+e.join("-")+"-cover");if(i&&i.childNodes.length>0)t.ajax.processScripts(l.SCRIPT);else t.defer(w,this)()}};t.defer(w,this)()}t.addClass(r,"feed-com-block-cover-wait");n.node=r;return r};t.MPL.prototype.clearThumb=function(e){if(e&&t(e.node)){t.removeClass(e.node,"feed-com-block-cover-wait")}};t.MPL.prototype.add=function(e,n,s){if(t.type.isArray(e)){t.MPL.superclass.add.apply(this,arguments)}else if(t(e["node"])){e["node"].setAttribute("id","record-"+n.join("-")+"-cover");t.MPL.superclass.add.apply(this,[n,s,true,"simple"])}else{t.MPL.superclass.add.apply(this,[n,s])}if(i["BitrixMobile"]&&i["BitrixMobile"]["LazyLoad"])setTimeout(function(){i.BitrixMobile.LazyLoad.showImages()},500)};t.MPL.prototype.send=function(){if(t(this.nav))t.addClass(this.nav.parentNode,"post-comments-button-waiter");t.MPL.superclass.send.apply(this,arguments)};t.MPL.prototype.build=function(){if(t(this.nav))t.removeClass(this.nav.parentNode,"post-comments-button-waiter");t.MPL.superclass.build.apply(this,arguments)};t.MPL.prototype.complete=function(){if(t(this.nav))t.removeClass(this.nav.parentNode,"post-comments-button-waiter");t.MPL.superclass.complete.apply(this,arguments)};t.MPL.prototype.showWait=function(e){var i=t("record-"+this.ENTITY_XML_ID+"-"+e+"-cover");if(e>0&&i)t.addClass(i,"feed-com-block-cover-wait")};t.MPL.prototype.closeWait=function(e){var i=t("record-"+this.ENTITY_XML_ID+"-"+e+"-cover");if(e>0&&i)t.removeClass(i,"feed-com-block-cover-wait")};t.MPL.createInstance=function(e,i,n){return new t.MPL(e,i,n)};t.MPL.getInstance=function(t){return e["list"][t]};t.addCustomEvent(i,"OnUCHasBeenDestroyed",function(t){delete e["list"][t]});t.onCustomEvent("main.post.list/mobile",["script.js"]);t.removeCustomEvent("main.post.list/default",function(){l(i)})};t.addCustomEvent("main.post.list/default",function(){l(window)});if(window["FCList"])l(window)})();
//# sourceMappingURL=script.map.js