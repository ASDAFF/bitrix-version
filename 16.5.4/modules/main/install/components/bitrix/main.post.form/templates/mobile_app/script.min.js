(function(){if(!window["BX"]||window["BX"]["MPF"]||!window["app"])return;var t={},e=function(t){if(BX.type.isNotEmptyString(t)){this.id=t;this.url=t;this.name=t.substr(t.lastIndexOf("/")+1);if(this.name.indexOf("?")>=0)this.name=this.name.substr(0,this.name.indexOf("?"));this.ext=this.name.lastIndexOf(".")>0?this.name.substr(this.name.lastIndexOf(".")+1).toLowerCase():""}else{for(var e in t){if(t.hasOwnProperty(e)){this[e]=t[e]}}}},i=function(t,e,i){this.id=e;this.url=window.location.protocol+"//"+window.location.host+this.urlUpload;this.values={};this.params=i;this.propertyName=this.params["FIELD_NAME"];this.handleBase64=BX.delegate(this.handleBase64,this);this.catchUF=BX.delegate(this.catchUF,this);this.parseUF=BX.delegate(this.parseUF,this);this.prepareToSaveUF=BX.delegate(this.prepareToSaveUF,this)};e.prototype={getErrorText:function(t){return t||BX.message("MPFFileWasNotUploaded")}};i.prototype={prefixHTMLNode:"disk-attach-",userTypeId:"disk_file",urlUpload:"/bitrix/tools/disk/uf.php?action=uploadFile&ncc=1",handleBase64:function(t,e){e.filesToPost=true;BX.addCustomEvent(t,"onUploadStart",BX.proxy(this.uploadBase64,this))},uploadBase64:function(t){var e=new window.FileUploadOptions,i=new window.FileTransfer,s=BX.proxy(function(e){e=BX.parseJSON(e.response);if(e==null)o();else this.uploadBase64Response(t,e)},this),o=BX.proxy(function(){this.uploadBase64Failure(t,BX.message("MPFIncorrectResponse"))},this);e.fileKey=this.userTypeId;e.fileName=t.name;e.params={sessid:BX.bitrix_sessid()};e.mimeType="image/jpeg";e.chunkedMode=false;i.upload(t.url,this.url,s,BX.proxy(function(){window.app.BasicAuth({success:BX.proxy(function(n){e.params.sessid=n.sessid_md5;i.upload(t.url,this.url,s,o,e)},this),failure:o})},this),e)},uploadBase64Failure:function(t,e){BX.onCustomEvent(t,"onUploadError",[t.getErrorText(e)])},uploadBase64Response:function(t,e){var i;if(e.status!="success"){i=e["message"];if(!i&&BX.type.isArray(e["errors"])){for(var s=0;s<e["errors"].length;s++){if(e["errors"][s]&&e["errors"][s]["message"]){i=(i||"")+e["errors"][s]["message"]}}}this.uploadBase64Failure(t,i)}else{e=e.data;var o=e["id"],n="blank";if(BX.util.in_array(t.ext,["jpg","bmp","jpeg","jpe","gif","png"]))n="img";else if(BX.util.in_array(t.ext,["doc","pdf","ppt","rar","xls","zip"]))n=t.ext;BX.onCustomEvent(t,"onUploadOk",["[DISK FILE ID="+o+"]",{extension:e["id"]["ext"],iconUrl:"/bitrix/components/bitrix/mobile.disk.file.detail/images/"+n+".png",previewImageUrl:"",id:o,fileId:o,xmlID:"0",name:e["id"]["name"],type:e["id"]["ext"],propertyName:this.propertyName,fieldName:this.propertyName+(this.params["MULTIPLE"]=="Y"?"[]":""),fieldValue:o,url:(BX.message("MobileSiteDir")||"/")+"mobile/ajax.php?attachedId="+o+"&action=download&ncc=1&mobile_action=disk_uf_view&filename="+e["id"]["name"]},this])}},catchUF:function(t,e,i){if(t&&t[this.propertyName]&&t[this.propertyName]["USER_TYPE_ID"]==this.userTypeId&&BX.type.isArray(t[this.propertyName]["VALUE"])){i["uf"]=i["uf"]||{};t=t[this.propertyName];var s=function(){var t="id"+Math.random();while(i["uf"][t])t="id"+Math.random();return t};for(var o=0,n,a,r,l,h,m,d;o<t["VALUE"].length;o++){a=t["VALUE"][o];n=BX(this.prefixHTMLNode+a);r=n.getAttribute("data-bx-title")||"noname";l=r.lastIndexOf(".")>0?r.substr(r.lastIndexOf(".")+1).toLowerCase():"";h="blank";d=s();if(BX.util.in_array(l,["jpg","bmp","jpeg","jpe","gif","png"]))h="img";else if(BX.util.in_array(l,["doc","pdf","ppt","rar","xls","zip"]))h=l;if(n){m={extension:l,iconUrl:"/bitrix/components/bitrix/mobile.disk.file.detail/images/"+h+".png",previewImageUrl:n.getAttribute("data-bx-src")||n.getAttribute("src")||undefined,id:d,fileId:n.getAttribute("bx-attach-file-id"),xmlID:n.getAttribute("bx-attach-xml-id"),name:r,type:l,propertyName:this.propertyName,fieldName:this.propertyName+(this.params["MULTIPLE"]=="Y"?"[]":""),fieldValue:a,url:(BX.message("MobileSiteDir")||"/")+"mobile/ajax.php?attachedId="+a+"&action=download&ncc=1&mobile_action=disk_uf_view&filename="+r};i["uf"][d]=m;e.push(m)}}}},parseUF:function(t,e){if(e&&e.length>0){var i=t.text,s,o;for(s=0;s<e.length;s++){o=e[s];if(o.propertyName==this.propertyName&&parseInt(o.fileId)>0){i=i.replace("[DISK FILE ID=n"+o.fileId+"]","[DISK FILE ID="+o.id+"]")}}t.text=i}},prepareToSaveUF:function(t,e){if(t.length>0){var i,s,o=[];for(i=0;i<t.length;i++){s=t[i];if(!s["propertyName"]&&s["base64"]){s["propertyName"]=this.propertyName;o.push(s)}else if(!s["propertyName"]&&s["VALUE"]){s["name"]=s["NAME"];s["ext"]=s["name"].lastIndexOf(".")>0?s["name"].substr(s["name"].lastIndexOf(".")+1).toLowerCase():"";s["id"]=s["ID"];s["fileId"]=s["ID"];s["xmlID"]=0;s["type"]=s["ext"];s["propertyName"]=this.propertyName;s["fieldName"]=this.propertyName+(this.params["MULTIPLE"]=="Y"?"[]":"");s["fieldValue"]=s["VALUE"];s["url"]=s["URL"]["URL"]}else if(!s["propertyName"]&&s["dataAttributes"]&&s["dataAttributes"]["VALUE"]){var n=s["dataAttributes"];s["name"]=n["NAME"];s["ext"]=s["name"].lastIndexOf(".")>0?s["name"].substr(s["name"].lastIndexOf(".")+1).toLowerCase():"";s["id"]=n["ID"];s["fileId"]=n["ID"];s["xmlID"]=0;s["type"]=s["ext"];s["propertyName"]=this.propertyName;s["fieldName"]=this.propertyName+(this.params["MULTIPLE"]=="Y"?"[]":"");s["fieldValue"]=n["VALUE"];s["url"]=n["URL"]["URL"]}}if(o.length>0){e.add(this,o)}}else{t.push({fieldName:this.propertyName+(this.params["MULTIPLE"]=="Y"?"[]":""),fieldValue:""})}},upload:function(t){var e=t.pop();if(e){var i=BX.proxy(function(o,n){BX.removeCustomEvent(e,"onUploadOk",i);BX.removeCustomEvent(e,"onUploadError",s);for(var a in n){if(n.hasOwnProperty(a)){e[a]=n[a]}}this.upload(t)},this),s=BX.proxy(function(t){BX.removeCustomEvent(e,"onUploadOk",i);BX.removeCustomEvent(e,"onUploadError",s);BX.onCustomEvent(this,"onUploadError",[t])},this);BX.addCustomEvent(e,"onUploadOk",i);BX.addCustomEvent(e,"onUploadError",s);this.uploadBase64(e);return}BX.onCustomEvent(this,"onUploadOk",[])}};var s=function(){};s.prototype={files:[],queue:{},getId:function(){return"id"+Math.random()},add:function(t,e){if(!t["__queueId"]){t.__queueId=this.getId();t.__onUploadOk=BX.delegate(function(){this.start(t)},this);t.__onUploadError=BX.delegate(this.error,this);BX.addCustomEvent(t,"onUploadOk",t.__onUploadOk);BX.addCustomEvent(t,"onUploadError",t.__onUploadError)}else{var i,s=(this.queue[t.__queueId]||[t,[]])[1];while((i=e.pop())&&i){s.push(i)}e=s}this.queue[t.__queueId]=[t,e]},start:function(t){if(t&&t.__queueId){this.clear(t)}var e;for(var i in this.queue){if(this.queue.hasOwnProperty(i)){e=this.queue[i];delete this.queue[i];if(e[0]&&e[0]["upload"]){e[0]["upload"](e[1])}else{this.start(e[0])}return}}BX.onCustomEvent(this,"onUploadOk",[])},clear:function(t){if(t.__queueId){delete this.queue[t.__queueId];delete t.__queueId;BX.removeCustomEvent(t,"onUploadOk",t.__onUploadOk);BX.removeCustomEvent(t,"onUploadError",t.__onUploadError);delete t.__onUploadOk;delete t.__onUploadError}},error:function(){var t=[],e;for(e in this.queue){if(this.queue.hasOwnProperty(e)){t.push(e)}}while((e=t.pop())&&e)this.clear(this.queue[e]);BX.onCustomEvent(this,"onUploadError",[BX.message("MPFFileWasNotUploaded")])},hasSmthToUpload:function(){for(var t in this.queue){if(this.queue.hasOwnProperty(t)){return true}}return false}};var o=function(t){this.handler=t;this.id=BX.util.getRandomString(8);this.params={placeholder:BX.message("MPFPlaceholder"),button_name:BX.message("MPFButtonSend"),mentionDataSource:{outsection:false,url:(BX.message("MobileSiteDir")?BX.message("MobileSiteDir"):"/")+"mobile/index.php?mobile_action=get_user_list&use_name_format=Y"},plusAction:BX.delegate(function(){new window.BXMobileApp.UI.ActionSheet({buttons:[{title:BX.message("MPFTakeAPhoto"),callback:BX.delegate(function(){window.app.takePhoto({source:1,correctOrientation:true,targetWidth:1e3,targetHeight:1e3,callback:BX.delegate(this.handleAppFile,this)})},this)},{title:BX.message("MPFSelectFromTheGallery"),callback:BX.delegate(function(){window.app.takePhoto({targetWidth:1e3,targetHeight:1e3,callback:BX.delegate(this.handleAppFile,this)})},this)}]},"textPanelSheet").show()},this),useImageButton:true,action:BX.delegate(this.handleAppData,this),callback:BX.delegate(this.handleAppCallback,this)}};o.prototype={handleAppData:function(t,e){if(!e){this.handler.comment.node=null}this.stopCheckWriting();BX.onCustomEvent(this,"onFormSubmitted",[t])},handleAppFile:function(t,i){if(!i){this.handler.comment.node=null}this.stopCheckWriting();var s=this;window.BXMobileApp.UI.Page.TextPanel.getText(function(i){BX.onCustomEvent(s,"onFileSubmitted",[i,new e(t)])})},handleAppCallback:function(t){if(this.writingParams.lastEvent!=t&&(!t||t["event"]!="removeFocus")){this.writingParams.lastEvent=t;this.writingParams.text+=t.text;this.writingParams["~text"]=t.text;window.app.onCustomEvent("main.post.form/text",[t.text]);if(this.writingParams.text.length>4){this.writingParams.text="";this.startCheckWriting()}}},init:function(t){t=t||"";this.params.text=t;window.BXMobileApp.UI.Page.TextPanel.show(this.params);if(BX.type.isNotEmptyString(t)){this.writingParams["~text"]=t}else{this.writingParams["~text"]=""}this.writingParams.text=""},show:function(t){if(BX.type.isString(t)){window.BXMobileApp.UI.Page.TextPanel.setText(t);this.writingParams["~text"]=t}window.BXMobileApp.UI.Page.TextPanel.focus()},clear:function(){this.writingParams.text="";this.writingParams["~text"]="";window.BXMobileApp.UI.Page.TextPanel.clear()},writingParams:{lastFired:0,lastEvent:null,frequency:1e4,text:"","~text":""},stopCheckWriting:function(){this.writingParams.text=""},startCheckWriting:function(){var t=new Date;if(t-this.writingParams.lastFired>this.writingParams.frequency){BX.onCustomEvent(this,"onUserIsWriting",[this]);this.writingParams.lastFired=t}},showWait:function(){window.BXMobileApp.UI.Page.TextPanel.showLoading(true)},closeWait:function(){window.BXMobileApp.UI.Page.TextPanel.showLoading(false)}};var n=function(t,e){this.handler=t;this.formSettings={attachButton:{items:this.initFiles(e["CID"])},attachFileSettings:{resize:[40,1,1,1e3,1e3,0,0,false,true,false,null,0],sendLocalFileMethod:"base64",saveToPhotoAlbum:true},attachedFiles:[],extraData:{},mentionButton:{dataSource:{return_full_mode:"YES",outsection:"NO",okname:BX.message("MPFButtonSend"),cancelname:BX.message("MPFButtonCancel"),multiple:"NO",alphabet_index:"YES",url:BX.message("MobileSiteDir")+"mobile/index.php?mobile_action=get_user_list"}},smileButton:{},message:{text:""},okButton:{callback:BX.delegate(this.applyExtendedForm,this),name:BX.message("MPFButtonSend")},cancelButton:{callback:BX.delegate(this.cancelExtendedForm,this),name:BX.message("MPFButtonCancel")}}};n.prototype={initFiles:function(t){this.controllers={};if(!t||typeof t!=="object")return[];var e,i=[],s;for(e in t){if(t.hasOwnProperty(e)){if(t[e]["USER_TYPE_ID"]=="disk_file"){s={id:"disk",name:BX.message("MPFPostFormDisk"),dataSource:{multiple:"NO",url:BX.message("SITE_DIR")+"mobile/?mobile_action=disk_folder_list&type=user&path=%2F&entityId="+BX.message("USER_ID")}};s.dataSource[window["platform"]=="ios"?"table_settings":"TABLE_SETTINGS"]={searchField:"YES",showtitle:"YES",modal:"YES",name:BX.message("MPFPostFormDiskTitle")};i.push(s)}}}if(i.length>0){i.push({id:"mediateka",name:BX.message("MPFPostFormPhotoGallery")});i.push({id:"camera",name:BX.message("MPFPostFormPhotoCamera")})}return i},applyExtendedForm:function(t){this.stopCheckWriting();t.text=t.text||"";t.attachedFiles=t.attachedFiles||[];for(var i=0;i<t.attachedFiles.length;i++){t.attachedFiles[i]=new e(t.attachedFiles[i])}t.extraData=t.extraData||{};BX.onCustomEvent(this,"onApplyComment",[t,t.attachedFiles]);BX.onCustomEvent(this,"onFormSubmitted",[t.text,t.attachedFiles,t.extraData])},cancelExtendedForm:function(){this.stopCheckWriting()},show:function(t,e){this.formSettings.message={text:t};this.formSettings.attachedFiles=[];this.formSettings.extraData={};if(e){BX.onCustomEvent(this,"onEditCommentUF",[e["UF"],this.formSettings.attachedFiles,this.formSettings.extraData]);BX.onCustomEvent(this,"onEditCommentFiles",[e["FILES"],this.formSettings.attachedFiles,this.formSettings.extraData])}window.app.exec("showPostForm",this.formSettings)},clear:function(){this.writingParams.text="";this.writingParams["~text"]=""},writingParams:{lastFired:0,lastEvent:null,frequency:1e4,text:""},stopCheckWriting:function(){this.writingParams.text=""},startCheckWriting:function(){var t=new Date;if(t-this.writingParams.lastFired>this.writingParams.frequency){this.writingParams.lastFired=t}},showWait:function(){},closeWait:function(){}};BX.MPF=function(e){if(!window.app.enableInVersion(4))throw this.errors["error00"];if(t[e["formId"]])t[e["formId"]].destroy();this.form=BX(e["formId"]);if(!this.form)throw this.errors["error01"];this.id=this.form.id;BX.hide(this.form);document.body.appendChild(this.form);this.text=this.form.elements[e.text.name];if(!this.text){this.text=BX.create("INPUT",{props:{type:"hidden",name:e.text.name,value:""}});this.form.appendChild(this.text)}this.block=BX.create("DIV",{className:"bx-additional-block-data"});this.form.appendChild(this.block);this.simpleForm=new o(this);this.extendedForm=new n(this,e);this.currentForm=null;t[this.id]=this;this.initEvents();this.controllers={};this.initControllers(e["CID"]);BX.onCustomEvent(window,"onMPFIsInitialized",[this])};BX.MPF.prototype={errors:{error00:"BX.MPL: Mobile Application is obsolete.",error01:"BX.MPL: form does not exist."},initEvents:function(){BX.addCustomEvent(this.simpleForm,"onFormSubmitted",BX.delegate(this.submitPlain,this));BX.addCustomEvent(this.simpleForm,"onFileSubmitted",BX.delegate(this.submitBase64,this));BX.addCustomEvent(this.simpleForm,"onUserIsWriting",BX.delegate(this.writing,this));BX.addCustomEvent(this.extendedForm,"onFormSubmitted",BX.delegate(this.submitExtended,this))},initControllers:function(t){if(t||typeof t=="object"){var e,s=false;for(e in t){if(t.hasOwnProperty(e)){if(t[e]["USER_TYPE_ID"]=="disk_file"){this.controllers[e]=new i(this,e,t[e]);if(!s){BX.addCustomEvent(this,"onBase64Submitted",this.controllers[e]["handleBase64"]);BX.addCustomEvent(this,"onBase64Upload",this.controllers[e]["uploadBase64"]);BX.addCustomEvent(this,"onExtendedSubmitted",this.controllers[e]["prepareToSaveUF"]);s=true}BX.addCustomEvent(this.extendedForm,"onEditCommentUF",this.controllers[e]["catchUF"]);BX.addCustomEvent(this.extendedForm,"onApplyComment",this.controllers[e]["parseUF"])}}}}},destroy:function(){BX.remove(this.form);BX.onCustomEvent(this.handler,"onMPFHasBeenDestroyed",[this.id,t[this.id],this]);t[this.id]=null},writing:function(){BX.onCustomEvent(this,"onMPFUserIsWriting",[this.comment])},setForm:function(t){this.currentForm=t===true?this.extendedForm:this.simpleForm},init:function(t){this.comment=t;this.setForm(false);this.simpleForm.init(t.text)},show:function(t,e){BX.onCustomEvent(this,"onShow",[this,t]);this.comment=t;this.setForm(e);this.currentForm.show(t.text,t.attachments)},clear:function(){if(this.currentForm!==null){this.currentForm.clear()}},submitBase64:function(t,e){var i={filesToPost:false};BX.onCustomEvent(this,"onBase64Submitted",[e,i]);if(i["filesToPost"]!==false){BX.onCustomEvent(this.comment,"onStart",[this.comment,t,[e]]);BX.addCustomEvent(e,"onUploadOk",BX.proxy(function(e,i){this.submit(BX.type.isNotEmptyString(t)?t:e,[i])},this));BX.addCustomEvent(e,"onUploadError",BX.proxy(this.error,this));BX.onCustomEvent(e,"onUploadStart",[e])}else{this.cancel()}},submitPlain:function(t,e){if(BX.type.isNotEmptyString(t)){BX.onCustomEvent(this.comment,"onStart",[this.comment,t,e]);this.submit(t,e)}else{this.cancel()}},submitExtended:function(t,e,i){if(!BX.type.isNotEmptyString(t)){this.cancel();return}if(typeof i!="undefined"&&typeof i["uf"]!="undefined"){for(var o=0,n,a;o<e.length;o++){if(e[o]&&e[o]["id"]&&i["uf"][e[o]["id"]]){for(a in i["uf"][e[o]["id"]]){if(i["uf"][e[o]["id"]].hasOwnProperty(a)){if(!e[o][a]){e[o][a]=i["uf"][e[o]["id"]][a]}}}e[o]["id"]=i["uf"][e[o]["id"]]["fieldValue"]}}}BX.onCustomEvent(this.comment,"onStart",[this.comment,t,e]);var r=new s;BX.onCustomEvent(this,"onExtendedSubmitted",[e,r]);if(r.hasSmthToUpload()){BX.addCustomEvent(r,"onUploadOk",BX.proxy(function(){this.submit(t,e)},this));BX.addCustomEvent(r,"onUploadError",BX.proxy(this.error,this));r.start()}else{this.submit(t,e)}},cancel:function(){this.setForm(false);this.clear();BX.onCustomEvent(this.comment,"onCancel",[this.comment])},error:function(t){this.setForm(false);this.clear();BX.onCustomEvent(this.comment,"onError",[this.comment,t])},submit:function(t,e,i){this.setForm(false);this.clear();this.comment.text=t;this.text.value=this.comment.getText();this.comment.attachments=e;this.comment.extraData=i;BX.onCustomEvent(this.comment,"onSubmit",[this.comment])},getForm:function(t){return BX.ajax.prepareForm(this.form,t).data},showWait:function(){if(this.currentForm!==null)this.currentForm.showWait()},closeWait:function(){if(this.currentForm!==null)this.currentForm.closeWait()}};BX.MPF.createInstance=function(e){if(!t[e["ID"]])new BX.MPF(e);return t[e["ID"]]};BX.MPF.getInstance=function(e){return t[e]};BX.onCustomEvent(window,"main.post.form/mobile",["mobile"])})();
//# sourceMappingURL=script.map.js